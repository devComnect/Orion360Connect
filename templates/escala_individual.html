<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Escala</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
  <link rel="icon" href="{{ url_for('static', filename='img/icone.png') }}" />

  <!-- Tabulator -->
  <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.1/dist/css/tabulator.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style_escala.css') }}" />
</head>

{% include 'header/model-header-individual.html' %}

<body>
<div class="container-fluid my-4 px-5">
<br><br><br><br>

  <!-- Título -->
  <h1>Escala Suporte</h1>

  <!-- Card que envolve a tabela -->
  <div class="card">
    <div class="card-header">
    </div>
    <div class="card-body">
      <div id="abas"></div>
      <div id="planilhas"></div>
    </div>
  </div>
</div>

<!-- JSON com dados -->
<script type="application/json" id="dados-json">
  {{ abas | tojson | safe }}
</script>

<!-- Tabulator + XLSX -->
<script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.1/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const abas = JSON.parse(document.getElementById('dados-json').textContent);
  const abasDiv = document.getElementById('abas');
  const planilhasDiv = document.getElementById('planilhas');
  const downloadBtn = document.getElementById('download-btn');
  const downloadOriginalBtn = document.getElementById('download-original-btn');

  const tabelas = {};
  let abaAtual = null;

  // Feriados fixos (formato DD/MM)
  const feriados = [
    "01/01", "25/01", "17/02", "03/04", "21/04", "01/05",
    "04/06", "09/07", "07/09", "12/10", "02/11", "15/11",
    "20/11", "25/12"
  ];

  // Função para gerar os dias do mês (para cada aba/mês)
  function gerarDiasDoMes(mesNome) {
    const meses = {
      'Janeiro': 0, 'Fevereiro': 1, 'Março': 2, 'Abril': 3,
      'Maio': 4, 'Junho': 5, 'Julho': 6, 'Agosto': 7,
      'Setembro': 8, 'Outubro': 9, 'Novembro': 10, 'Dezembro': 11
    };
    const ano = new Date().getFullYear();
    const mes = meses[mesNome] ?? 0;
    const ultimoDia = new Date(ano, mes + 1, 0).getDate();

    const dias = [];
    for (let d = 1; d <= ultimoDia; d++) {
      dias.push(`${d.toString().padStart(2, '0')}/${(mes + 1).toString().padStart(2, '0')}`);
    }
    return dias;
  }

  abas.forEach(({nome, dados}, index) => {
    const dadosFiltrados = dados.slice(15);
    const colunasOriginais = Object.keys(dadosFiltrados[0] || []);
    const primeiraColuna = colunasOriginais[0];

    const diasDoMes = gerarDiasDoMes(nome);
    const colunasOrdenadas = [primeiraColuna, ...diasDoMes];

    const dadosReestruturados = dadosFiltrados.map(linha => {
      const novaLinha = { [primeiraColuna]: linha[primeiraColuna] };
      diasDoMes.forEach((dia, i) => {
        const valorOriginal = linha[colunasOriginais[i + 1]] ?? '';
        novaLinha[dia] = valorOriginal;
      });
      return novaLinha;
    });

    // Botão da aba
    const btn = document.createElement('button');
    btn.textContent = nome;
    btn.classList.add('btn', 'btn-outline-primary', 'me-1', 'aba-btn');
    if(index === 0) {
      btn.classList.add('active');
      abaAtual = nome;
    }
    btn.addEventListener('click', () => {
      document.querySelectorAll('.aba-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      document.querySelectorAll('.planilha-container').forEach(div => div.classList.remove('active'));
      document.getElementById(`planilha-${nome}`).classList.add('active');

      abaAtual = nome;
    });
    abasDiv.appendChild(btn);

    // Container da planilha
    const container = document.createElement('div');
    container.id = `planilha-${nome}`;
    container.classList.add('planilha-container', 'mt-3');
    if(index === 0) container.classList.add('active');
    planilhasDiv.appendChild(container);

    // Define colunas com estilos personalizados
    const colunas = colunasOrdenadas.map(campo => ({
      title: campo,
      field: campo,
      editor: "input",
      headerFilter: "input",
      formatter: (cell) => {
        const valor = cell.getValue();
        const coluna = cell.getColumn().getField();

        const turnos = {
          'T1': '#d4edda', // verde claro
          'T2': '#a9dfbf', // verde médio
          'T3': '#7dcea0', // verde escuro
          'VA': '#f8d7da', // rosa claro
          'SB': '#f5c6cb', // vermelho alaranjado
          'DO': '#e2e3e5', // cinza claro
          'E1': '#d0e2f2', // azul claro
          'E2': '#a9cce3', // azul médio
          'E3': '#7fb3d5',  // azul escuro
          'SÁB':'#4169E1',
        };

        const cor = turnos[valor];
        if (cor) {
          cell.getElement().style.backgroundColor = cor;
          cell.getElement().style.color = '#000';
          cell.getElement().style.fontWeight = 'bold';
        }

        // Feriado (pinta apenas as células dos dias que são feriados)
        if (feriados.includes(coluna)) {
          cell.getElement().style.backgroundColor = '#d6b3ff'; // roxo claro
          cell.getElement().style.color = '#000';
          cell.getElement().style.fontWeight = 'bold';
        }

        return valor;
      }
    }));

    // Inicializa Tabulator
    tabelas[nome] = new Tabulator(container, {
      data: dadosReestruturados,
      columns: colunas,
      layout: "fitColumns",
      movableColumns: true,
      pagination: "local",
      paginationSize: 20,
      cellEdited: (cell) => {
        console.log(`Editado na aba ${nome}: campo=${cell.getField()}, valor=${cell.getValue()}`, cell.getRow().getData());
      }
    });
  });

  // Download da aba atual
  downloadBtn.addEventListener('click', () => {
    if(!abaAtual) return alert("Nenhuma aba selecionada.");
    const table = tabelas[abaAtual];
    const dados = table.getData();
    if(dados.length === 0) return alert("A aba está vazia.");

    const ws = XLSX.utils.json_to_sheet(dados);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, abaAtual);
    XLSX.writeFile(wb, `escala_${abaAtual}.xlsx`);
  });

  // Download da planilha original
  downloadOriginalBtn.addEventListener('click', () => {
    window.location.href = '/escala/download_original';
  });

  // Função para atualizar a tabela da aba atual com dados importados
  function atualizarTabelaComDados(abaNome, dadosImportados) {
    if (!tabelas[abaNome]) {
      alert('Tabela da aba não encontrada.');
      return;
    }
    
    const tabela = tabelas[abaNome];
    const colunas = tabela.getColumns().map(col => col.getField());
    const primeiraColuna = colunas[0]; // Ex: "Funcionário"

    const dadosReestruturados = dadosImportados.map(linha => {
      const novaLinha = {};
      colunas.forEach(campo => {
        novaLinha[campo] = linha[campo] ?? '';
      });
      return novaLinha;
    });

    tabela.replaceData(dadosReestruturados);
  }

  // Evento upload
  document.getElementById('upload-file').addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});

      const abaNome = abaAtual;
      if (!abaNome) {
        alert("Nenhuma aba selecionada.");
        return;
      }

      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];

      const dadosImportados = XLSX.utils.sheet_to_json(worksheet, {defval: ''});

      atualizarTabelaComDados(abaNome, dadosImportados);

      alert(`Planilha importada com sucesso para a aba "${abaNome}".`);
    };

    reader.readAsArrayBuffer(file);

    event.target.value = '';
  });
});
</script>

<!-- Estilo -->
<style>
  .planilha-container { display: none; }
  .planilha-container.active { display: block; }
  .aba-btn.active {
    background-color: #0d6efd;
    color: white;
  }
</style>

</body>
</html>
