{% extends "base_template.html" %}

{% block title %}Rankings Globais{% endblock %}

{% block styles %}
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-blue: #0dcaf0;
            --neon-gold: #ffd700;
            --neon-silver: #e0e0e0;
            --neon-bronze: #cd7f32;
            --bg-dark: #0b0c10;
            --panel-bg: #1f2833;
            --border-tech: #45a29e;
        }

        body { 
            background-color: var(--bg-dark); 
            font-family: 'Segoe UI', sans-serif;
            background-image: radial-gradient(circle at 50% 0%, #1a2634 0%, #0b0c10 70%);
        }

        .font-tech { font-family: 'Share Tech Mono', monospace; }

        /* --- HEADER & COUNTDOWN --- */
        .ranking-header {
            text-align: center;
            padding: 50px 0 30px;
            position: relative;
        }

        .ranking-title {
            font-family: 'Share Tech Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: #fff;
            text-shadow: 0 0 20px rgba(13, 202, 240, 0.4);
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .season-timer-card {
            display: inline-flex;
            align-items: center;
            background: rgba(0,0,0,0.6);
            border: 1px solid var(--border-tech);
            padding: 10px 25px;
            border-radius: 50px;
            gap: 15px;
            box-shadow: 0 0 15px rgba(69, 162, 158, 0.2);
        }

        .btn-rewards-tech {
            background: linear-gradient(90deg, var(--neon-gold), #ffc107);
            color: #000;
            border: none;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.4);
            transition: transform 0.2s;
        }
        .btn-rewards-tech:hover { transform: scale(1.05); }

        /* --- TABS --- */
        .tech-tabs .nav-link {
            color: #8892b0;
            font-family: 'Share Tech Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid transparent;
            margin: 0 5px;
            transition: all 0.3s;
        }
        .tech-tabs .nav-link.active {
            background: rgba(13, 202, 240, 0.1);
            color: var(--neon-blue);
            border-color: var(--neon-blue);
            box-shadow: 0 0 10px rgba(13, 202, 240, 0.15);
        }
        .tech-tabs .nav-link:hover:not(.active) {
            color: #fff;
            border-color: rgba(255,255,255,0.2);
        }

        /* --- PODIUM (TOP 3) --- */
        .podium-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin-bottom: 50px;
            padding-top: 20px;
            gap: 20px;
        }

        .podium-card {
            background: var(--panel-bg);
            border: 1px solid #333;
            width: 220px;
            text-align: center;
            padding: 20px;
            position: relative;
            clip-path: polygon(15% 0, 100% 0, 100% 100%, 0 100%, 0 15%);
            transition: transform 0.3s;
        }
        
        .podium-card:hover { transform: translateY(-10px); }

        /* Tamanhos e Cores do Pódio */
        .podium-1 { height: 280px; order: 2; border-top: 4px solid var(--neon-gold); z-index: 2; }
        .podium-2 { height: 240px; order: 1; border-top: 4px solid var(--neon-silver); }
        .podium-3 { height: 220px; order: 3; border-top: 4px solid var(--neon-bronze); }

        .podium-avatar-wrapper {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
        }
        
        .podium-1 .podium-avatar-wrapper { width: 100px; height: 100px; }

        .podium-avatar {
            width: 100%; height: 100%;
            object-fit: cover;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); /* Hexagon */
            background: #000;
        }

        .crown-icon {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            color: var(--neon-gold);
            text-shadow: 0 0 10px var(--neon-gold);
            animation: float 3s ease-in-out infinite;
        }

        .podium-rank {
            font-size: 3rem;
            font-weight: bold;
            font-family: 'Share Tech Mono', monospace;
            opacity: 0.5;
            position: absolute;
            bottom: 0;
            right: 10px;
            line-height: 1;
        }

        .podium-name {
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .podium-score {
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.2rem;
            color: var(--neon-blue);
        }

        /* --- LISTA GERAL (4º EM DIANTE) --- */
        .ranking-list-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .rank-row {
            display: flex;
            align-items: center;
            background: rgba(31, 40, 51, 0.6);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding: 15px 20px;
            transition: background 0.2s;
            position: relative;
        }

        .rank-row:hover { background: rgba(31, 40, 51, 0.9); }
        
        .rank-row.current-user {
            background: rgba(13, 202, 240, 0.1);
            border-left: 4px solid var(--neon-blue);
        }

        .rank-num {
            width: 50px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.2rem;
            color: #8892b0;
            text-align: center;
        }

        .rank-user-info {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: 20px;
        }

        .mini-avatar {
            width: 40px; height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #444;
        }

        .rank-user-name {
            font-weight: 600;
            color: #fff;
        }

        .rank-dept-small {
            font-size: 0.75rem;
            color: #8892b0;
            text-transform: uppercase;
        }

        .rank-total-score {
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.1rem;
            color: #fff;
            text-align: right;
            min-width: 100px;
        }

        /* Feedback Visual de Clique */
        .rank-row {
            cursor: pointer; /* Garante que o cursor vire 'mãozinha' em toda a linha */
        }

        .rank-row:hover {
            background: rgba(31, 40, 51, 0.9);
            border-color: var(--neon-blue); /* Borda acende ao passar o mouse */
            transform: translateX(5px); /* Leve movimento para a direita */
        }

        /* Opcional: Efeito no Pódio ao passar o mouse */
        .podium-card {
            display: block; /* Necessário pois mudamos de div para a */
            cursor: pointer;
        }
        /* --- TERMINAL MODAL DESIGN --- */
        .terminal-content {
            background-color: #0a0a0a;
            border: 2px solid var(--neon-blue);
            box-shadow: 0 0 30px rgba(13, 202, 240, 0.15);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        /* Scanline Effect (Linha passando) */
        .terminal-content::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .terminal-header-bar {
            background: var(--neon-blue);
            color: #000;
            padding: 5px 10px;
            font-family: 'Share Tech Mono', monospace;
            font-weight: bold;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .terminal-body {
            padding: 20px;
            min-height: 300px;
            font-family: 'Share Tech Mono', monospace;
            color: #fff;
            font-size: 1rem;
            overflow-y: auto;
            position: relative;
            z-index: 3;
        }

        /* Textos do Terminal */
        .term-line {
            margin-bottom: 5px;
            opacity: 0; /* Começa invisível para animação */
            transform: translateX(-10px);
            transition: all 0.1s ease-out;
        }
        .term-line.visible {
            opacity: 1;
            transform: translateX(0);
        }

        .term-prefix { color: var(--neon-blue); margin-right: 10px; }
        .term-success { color: var(--neon-green); }
        .term-warning { color: var(--neon-gold); }
        .term-highlight { color: #fff; font-weight: bold; background: rgba(13, 202, 240, 0.2); padding: 0 5px; }

        /* Cursor Piscante */
        .cursor-blink {
            display: inline-block;
            width: 10px;
            height: 1.2em;
            background-color: var(--neon-blue);
            animation: blink 1s step-end infinite;
            vertical-align: text-bottom;
            margin-left: 5px;
        }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* Custom Scrollbar para o terminal */
        .terminal-body::-webkit-scrollbar { width: 8px; }
        .terminal-body::-webkit-scrollbar-track { background: #000; }
        .terminal-body::-webkit-scrollbar-thumb { background: var(--neon-blue); border-radius: 4px; }
        
        @keyframes float { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -10px); } }
    </style>
{% endblock %}

{% block content %}
{% import 'guardians/macros/render_trophy.html' as macros with context%}

<div class="ranking-header">
    <div class="container">
        <h1 class="ranking-title">RANKING GLOBAL</h1>
        
        <div class="season-timer-card font-tech">
            <div id="season-countdown">
                <i class="bi bi-clock-history text-info me-2"></i>
                <span class="text-white">--d --h --m --s</span>
            </div>
            <button type="button" class="btn-rewards-tech" data-bs-toggle="modal" data-bs-target="#rewardsModalPlaceholder">
                 VER PRÊMIOS
            </button>
        </div>
    </div>
</div>

<div class="container mb-5">

    <ul class="nav nav-pills justify-content-center mb-5 tech-tabs" id="rankingTab" role="tablist">
         <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#individual"><i class="bi bi-person-fill"></i> GERAL</button></li>
         <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#streak"><i class="bi bi-fire"></i> VIGILANTE</button></li>
    </ul>

    <div class="tab-content" id="rankingTabContent">

    <div class="tab-content" id="rankingTabContent">

    <div class="tab-pane fade show active" id="individual">
        {% if ranking_global %}
            
            {# --- PODIUM (TOP 3) --- #}
            {% if ranking_global|length >= 3 %}
            <div class="podium-container d-none d-md-flex">
                
                {# --- 2º LUGAR --- #}
                {% set p2 = ranking_global[1] %}
                <a href="{{ url_for('guardians_bp.meu_perfil', perfil_id=p2.id) }}" class="podium-card podium-2 text-decoration-none">
                    <div class="podium-avatar-wrapper">
                        {% if p2.avatar_seed %}
                            <img src="https://api.dicebear.com/9.x/bottts/svg?seed={{ p2.avatar_seed }}" class="podium-avatar" alt="Avatar">
                        {% else %}
                            {# Placeholder Icon #}
                            <div class="podium-avatar d-flex align-items-center justify-content-center bg-dark border border-secondary">
                                <i class="bi bi-person-circle text-muted" style="font-size: 2.5rem;"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="podium-name">{{ p2.nickname or p2.nome }}</div>
                    <div class="podium-score">{{ p2.score_atual }} XP</div>
                    <div class="podium-rank">2</div>
                </a>

                {# --- 1º LUGAR --- #}
                {% set p1 = ranking_global[0] %}
                <a href="{{ url_for('guardians_bp.meu_perfil', perfil_id=p1.id) }}" class="podium-card podium-1 text-decoration-none">
                    <div class="podium-avatar-wrapper">
                        <i class="bi bi-crown-fill crown-icon"></i>
                        
                        {% if p1.avatar_seed %}
                            <img src="https://api.dicebear.com/9.x/bottts/svg?seed={{ p1.avatar_seed }}" class="podium-avatar" style="border: 2px solid #ffd700;" alt="Avatar">
                        {% else %}
                            <div class="podium-avatar d-flex align-items-center justify-content-center bg-dark" style="border: 2px solid #ffd700;">
                                <i class="bi bi-person-circle text-warning" style="font-size: 3rem;"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="podium-name text-warning">{{ p1.nickname or p1.nome }}</div>
                    <div class="podium-score">{{ p1.score_atual }} XP</div>
                    <div class="podium-rank">1</div>
                </a>

                {# --- 3º LUGAR --- #}
                {% set p3 = ranking_global[2] %}
                <a href="{{ url_for('guardians_bp.meu_perfil', perfil_id=p3.id) }}" class="podium-card podium-3 text-decoration-none">
                    <div class="podium-avatar-wrapper">
                        {% if p3.avatar_seed %}
                            <img src="https://api.dicebear.com/9.x/bottts/svg?seed={{ p3.avatar_seed }}" class="podium-avatar" alt="Avatar">
                        {% else %}
                            <div class="podium-avatar d-flex align-items-center justify-content-center bg-dark border border-secondary">
                                <i class="bi bi-person-circle text-muted" style="font-size: 2.5rem;"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="podium-name">{{ p3.nickname or p3.nome }}</div>
                    <div class="podium-score">{{ p3.score_atual }} XP</div>
                    <div class="podium-rank">3</div>
                </a>
            </div>
            {% endif %}

            {# --- LISTA GERAL --- #}
            <div class="ranking-list-container">
                {% for perfil in ranking_global %}
                    <div class="rank-row {% if loop.index <= 3 %}d-md-none{% endif %} {% if perfil.id == current_user_id %}current-user{% endif %}">
                        <div class="rank-num">#{{ loop.index }}</div>
                        <div class="rank-user-info">
                            
                            {# Lógica do Avatar na Lista #}
                            {% if perfil.avatar_seed %}
                                <img src="https://api.dicebear.com/9.x/bottts/svg?seed={{ perfil.avatar_seed }}" class="mini-avatar" alt="Avatar">
                            {% else %}
                                <div class="mini-avatar d-flex align-items-center justify-content-center bg-dark border border-secondary" style="width: 40px; height: 40px; border-radius: 50%;">
                                    <i class="bi bi-person-circle text-muted" style="font-size: 1.2rem;"></i>
                                </div>
                            {% endif %}
                            
                            <div>
                                <div class="rank-user-name">
                                    <a href="{{ url_for('guardians_bp.meu_perfil', perfil_id=perfil.id) }}" class="text-white text-decoration-none stretched-link">
                                        {{ perfil.nickname or perfil.nome }}
                                    </a>
                                </div>
                                <div class="rank-dept-small">{{ perfil.departamento_nome or 'N/A' }}</div>
                            </div>
                        </div>
                        <div class="rank-total-score">{{ perfil.score_atual }}</div>
                        
                        <div class="ms-3 text-muted opacity-50">
                            <i class="bi bi-chevron-right"></i>
                        </div>
                    </div>
                {% endfor %}
            </div>

        {% else %}
            <div class="text-center py-5 text-muted font-tech">// SEM DADOS DE RANKING //</div>
        {% endif %}
    </div>

    <div class="tab-pane fade" id="streak">
        {% if ranking_streak %}
            
            {# --- PODIUM STREAK (TOP 3) --- #}
            {% if ranking_streak|length >= 3 %}
            <div class="podium-container d-none d-md-flex">
                
                {# --- 2º LUGAR (Prata) --- #}
                {% set s2 = ranking_streak[1] %}
                <a href="{{ url_for('guardians_bp.meu_perfil', perfil_id=s2.id) }}" class="podium-card podium-2 text-decoration-none">
                    <div class="podium-avatar-wrapper">
                        {% if s2.avatar_seed %}
                            <img src="https://api.dicebear.com/9.x/bottts/svg?seed={{ s2.avatar_seed }}" class="podium-avatar" alt="Avatar">
                        {% else %}
                            <div class="podium-avatar d-flex align-items-center justify-content-center bg-dark border border-secondary">
                                <i class="bi bi-person-circle text-muted" style="font-size: 2.5rem;"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="podium-name">{{ s2.nickname or s2.nome }}</div>
                    <div class="podium-score text-danger"><i class="bi bi-fire"></i> {{ s2.current_streak }}</div>
                    <div class="podium-rank">2</div>
                </a>

                {# --- 1º LUGAR (Fogo/Vermelho) --- #}
                {% set s1 = ranking_streak[0] %}
                <a href="{{ url_for('guardians_bp.meu_perfil', perfil_id=s1.id) }}" class="podium-card podium-1 text-decoration-none">
                    <div class="podium-avatar-wrapper">
                        <i class="bi bi-fire crown-icon text-danger"></i>
                        
                        {% if s1.avatar_seed %}
                            <img src="https://api.dicebear.com/9.x/bottts/svg?seed={{ s1.avatar_seed }}" class="podium-avatar" style="border: 2px solid #dc3545;" alt="Avatar">
                        {% else %}
                            {# Ícone Vermelho se for Top 1 sem avatar #}
                            <div class="podium-avatar d-flex align-items-center justify-content-center bg-dark" style="border: 2px solid #dc3545;">
                                <i class="bi bi-person-circle text-danger" style="font-size: 3rem;"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="podium-name text-white">{{ s1.nickname or s1.nome }}</div>
                    <div class="podium-score text-danger fw-bold" style="font-size: 1.4rem;"><i class="bi bi-fire"></i> {{ s1.current_streak }}</div>
                    <div class="podium-rank">1</div>
                </a>

                {# --- 3º LUGAR (Bronze) --- #}
                {% set s3 = ranking_streak[2] %}
                <a href="{{ url_for('guardians_bp.meu_perfil', perfil_id=s3.id) }}" class="podium-card podium-3 text-decoration-none">
                    <div class="podium-avatar-wrapper">
                        {% if s3.avatar_seed %}
                            <img src="https://api.dicebear.com/9.x/bottts/svg?seed={{ s3.avatar_seed }}" class="podium-avatar" alt="Avatar">
                        {% else %}
                            <div class="podium-avatar d-flex align-items-center justify-content-center bg-dark border border-secondary">
                                <i class="bi bi-person-circle text-muted" style="font-size: 2.5rem;"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="podium-name">{{ s3.nickname or s3.nome }}</div>
                    <div class="podium-score text-danger"><i class="bi bi-fire"></i> {{ s3.current_streak }}</div>
                    <div class="podium-rank">3</div>
                </a>
            </div>
            {% endif %}

            {# --- LISTA GERAL (STREAK) --- #}
            <div class="ranking-list-container">
                {% for perfil in ranking_streak %}
                    <div class="rank-row {% if loop.index <= 3 %}d-md-none{% endif %} {% if perfil.id == current_user_id %}current-user{% endif %}">
                        <div class="rank-num">#{{ loop.index }}</div>
                        
                        <div class="rank-user-info">
                            {# Lógica Avatar Lista #}
                            {% if perfil.avatar_seed %}
                                <img src="https://api.dicebear.com/9.x/bottts/svg?seed={{ perfil.avatar_seed }}" class="mini-avatar" alt="Avatar">
                            {% else %}
                                <div class="mini-avatar d-flex align-items-center justify-content-center bg-dark border border-secondary" style="width: 40px; height: 40px; border-radius: 50%;">
                                    <i class="bi bi-person-circle text-muted" style="font-size: 1.2rem;"></i>
                                </div>
                            {% endif %}

                            <div>
                                <div class="rank-user-name">
                                    <a href="{{ url_for('guardians_bp.meu_perfil', perfil_id=perfil.id) }}" class="text-white text-decoration-none stretched-link">
                                        {{ perfil.nickname or perfil.nome }}
                                    </a>
                                </div>
                                <div class="rank-dept-small text-muted">OFENSIVA</div>
                            </div>
                        </div>
                        
                        <div class="rank-total-score text-danger">
                            <i class="bi bi-fire me-1"></i> {{ perfil.current_streak }}
                        </div>
                        
                        <div class="ms-3 text-muted opacity-50"><i class="bi bi-chevron-right"></i></div>
                    </div>
                {% endfor %}
            </div>

        {% else %}
            <div class="text-center py-5 text-muted font-tech">// NENHUMA OFENSIVA ATIVA //</div>
        {% endif %}
    </div>

    </div> </div>

    <div class="modal fade" id="rewardsModalPlaceholder" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-transparent border-0">
                
                <div class="terminal-content">
                    <div class="terminal-header-bar">
                        <span><i class="bi bi-terminal-fill me-2"></i>ROOT_ACCESS // REWARDS_PROTOCOL.EXE</span>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1); opacity: 1;"></button>
                    </div>

                    <div class="terminal-body" id="terminalDisplay">
                        <span class="cursor-blink"></span>
                    </div>
                </div>

                <div id="rawRewardsData" class="d-none">
                    {% if active_season and active_season.rewards_description_html %}
                        {{ active_season.rewards_description_html|safe }}
                    {% else %}
                        <p class="text-danger">ERRO: DADOS CRIPTOGRAFADOS OU INEXISTENTES.</p>
                        <p>O comando central ainda não liberou a lista de recompensas para esta temporada.</p>
                        <p>Verifique novamente em T-Minus 24 horas.</p>
                    {% endif %}
                </div>

            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Inicializa Tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) { return new bootstrap.Tooltip(tooltipTriggerEl); });

    // Countdown
    const countdownElement = document.getElementById('season-countdown');
    const expiryISO = {{ active_season.end_date.isoformat()|tojson if active_season else 'null' }};

    if (countdownElement && expiryISO) {
        const endDate = new Date(expiryISO);
        function updateCountdown() {
            const now = new Date();
            const diff = endDate - now;
            const span = countdownElement.querySelector('span');
            
            if (diff <= 0) {
                span.innerHTML = '<strong class="text-danger">TEMPORADA FINALIZADA</strong>';
                if(intervalId) clearInterval(intervalId);
                return;
            }
            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
            const m = Math.floor((diff / 1000 / 60) % 60);
            span.innerHTML = `<strong>${d}d ${h}h ${m}m</strong> RESTANTES`;
        }
        updateCountdown();
        const intervalId = setInterval(updateCountdown, 60000); // Atualiza a cada minuto é suficiente
    } else if (countdownElement) {
        countdownElement.querySelector('span').textContent = 'SEM TEMPORADA ATIVA';
    }

    const rewardsModal = document.getElementById('rewardsModalPlaceholder');
    const terminalDisplay = document.getElementById('terminalDisplay');
    const rawDataContainer = document.getElementById('rawRewardsData');

    if (rewardsModal) {
        rewardsModal.addEventListener('shown.bs.modal', function () {
            // 1. Limpa o terminal e prepara o cursor
            terminalDisplay.innerHTML = '<div class="term-line visible"><span class="term-prefix">sys@guardian:~$</span> ./decrypt_rewards.sh</div><span class="cursor-blink"></span>';
            
            // 2. Prepara os dados para "impressão"
            // Pegamos o HTML cru e dividimos em "linhas" lógicas
            // Se o HTML do admin usar <ul><li>, vamos tratar cada <li> como uma linha de terminal
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = rawDataContainer.innerHTML;
            
            let linesToPrint = [];
            
            // Sequência de Boot (Fake)
            linesToPrint.push({ text: "Conectando ao servidor seguro...", type: 'normal' });
            linesToPrint.push({ text: "Verificando credenciais...", type: 'normal' });
            linesToPrint.push({ text: "ACESSO CONCEDIDO. Baixando manifesto de prêmios...", type: 'success' });
            linesToPrint.push({ text: "------------------------------------------------", type: 'normal' });

            // Extrai o texto real do HTML escondido
            // Aqui tentamos ser inteligentes: pegar parágrafos e itens de lista
            const elements = tempDiv.querySelectorAll('p, li, h1, h2, h3, h4, h5');
            
            if (elements.length > 0) {
                elements.forEach(el => {
                    let type = 'normal';
                    let content = el.innerHTML;
                    
                    // Se for título, damos destaque
                    if (['H1','H2','H3','H4'].includes(el.tagName)) {
                        content = `[ ${el.innerText.toUpperCase()} ]`;
                        type = 'warning';
                    }
                    // Se for item de lista, adiciona um marcador
                    if (el.tagName === 'LI') {
                        content = `>> ${el.innerHTML}`;
                    }
                    
                    linesToPrint.push({ text: content, type: type });
                });
            } else {
                // Se não tiver tags, pega o texto puro
                linesToPrint.push({ text: tempDiv.innerText, type: 'normal' });
            }
            
            linesToPrint.push({ text: "------------------------------------------------", type: 'normal' });
            linesToPrint.push({ text: "FIM DA TRANSMISSÃO.", type: 'muted' });

            // 3. Função de Digitação (Line by Line)
            let lineIndex = 0;
            
            // Remove o cursor atual para reinserí-lo no final a cada linha
            const cursor = terminalDisplay.querySelector('.cursor-blink');
            
            const printInterval = setInterval(() => {
                if (lineIndex >= linesToPrint.length) {
                    clearInterval(printInterval);
                    return;
                }

                const lineData = linesToPrint[lineIndex];
                
                // Cria elemento da linha
                const p = document.createElement('div');
                p.classList.add('term-line');
                
                // Define cor baseada no tipo
                let colorClass = 'text-white';
                if (lineData.type === 'success') colorClass = 'term-success';
                if (lineData.type === 'warning') colorClass = 'term-warning';
                if (lineData.type === 'muted') colorClass = 'text-muted';

                p.innerHTML = `<span class="term-prefix">></span> <span class="${colorClass}">${lineData.text}</span>`;
                
                // Insere antes do cursor
                terminalDisplay.insertBefore(p, cursor);
                
                // Trigger da animação CSS (pequeno delay para o browser renderizar)
                setTimeout(() => p.classList.add('visible'), 10);
                
                // Scroll automático para baixo
                terminalDisplay.scrollTop = terminalDisplay.scrollHeight;

                lineIndex++;
            }, 150); // Velocidade entre linhas (ms)
        });
        
        // Reseta quando fechar para poder tocar a animação de novo
        rewardsModal.addEventListener('hidden.bs.modal', function () {
            terminalDisplay.innerHTML = '';
        });
    }

});
</script>
{% endblock %}