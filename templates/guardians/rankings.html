{% extends "base_template.html" %}

{% block title %}Rankings{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-center mb-4 text-white">Ranking de Segurança</h1>

    <ul class="nav nav-pills justify-content-center mb-4" id="rankingTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="individual-tab" data-bs-toggle="tab" data-bs-target="#individual" type="button" role="tab"><i class="bi bi-person-fill me-2"></i>Por Pontos</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="streak-tab" data-bs-toggle="tab" data-bs-target="#streak" type="button" role="tab"><i class="bi bi-fire me-2"></i>Dias de Vigilante</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="departamento-tab" data-bs-toggle="tab" data-bs-target="#departamento" type="button" role="tab"><i class="bi bi-building-fill me-2"></i>Por Departamento</button>
        </li>
    </ul>

    <div class="tab-content" id="rankingTabContent">
        
        <div class="tab-pane fade show active" id="individual" role="tabpanel">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <table class="table table-dark table-borderless align-middle ranking-table">
                        <thead><tr><th class="text-center">Posição</th><th colspan="2">Colaborador</th><th class="text-end">Pontuação</th></tr></thead>
                        <tbody>
                            {% for perfil in ranking_global %}
                                <tr class="ranking-row {% if perfil.id == current_user_id %}current-user-highlight{% endif %}">
                                    <td class="text-center">
                                        {% if loop.index == 1 %}<span class="rank-position rank-medal gold" title="1º Lugar"><i class="bi bi-trophy-fill"></i></span>{% elif loop.index == 2 %}<span class="rank-position rank-medal silver" title="2º Lugar"><i class="bi bi-trophy-fill"></i></span>{% elif loop.index == 3 %}<span class="rank-position rank-medal bronze" title="3º Lugar"><i class="bi bi-trophy-fill"></i></span>{% else %}<span class="rank-position rank-number">{{ loop.index }}º</span>{% endif %}
                                    </td>
                                    <td style="width: 60px;"><img src="{{ url_for('static', filename=perfil.nivel.badge_icon_url if perfil.nivel else 'img/badges/default.png') }}" class="ranking-avatar"></td>
                                    <td>
                                        {# 1. Define as variáveis de exibição com base nas regras #}
                                        {% set is_anonymous_for_others = perfil.is_anonymous and perfil.id != current_user_id %}

                                        {% if is_anonymous_for_others %}
                                            {% set display_name = 'Guardião Anônimo' %}
                                            {% set is_clickable = False %}
                                        {% else %}
                                            {% set is_clickable = True %}
                                            {% if perfil.opt_in_real_name_ranking or not perfil.nickname %}
                                                {# Mostra o nome real se o usuário marcou a opção OU se não tem apelido #}
                                                {% set display_name = perfil.nome %}
                                            {% else %}
                                                {# Caso contrário, mostra o apelido #}
                                                {% set display_name = perfil.nickname %}
                                            {% endif %}
                                        {% endif %}
                                        <a href="{% if is_clickable %}{{ url_for('guardians_bp.meu_perfil', perfil_id=perfil.id) }}{% else %}#{% endif %}" 
                                           class="text-white text-decoration-none {% if not is_clickable %}pe-none text-muted{% endif %}">

                                            <strong {% if perfil.name_color and is_clickable %} style="color: {{ perfil.name_color }}; text-shadow: 0 0 5px {{ perfil.name_color }};" {% endif %}>
                                                {{ display_name }}
                                            </strong>

                                            {% if perfil.featured_insignia and is_clickable %}
                                                <img src="{{ url_for('static', filename=perfil.featured_insignia.caminho_imagem) }}" class="featured-insignia-badge" data-bs-toggle="tooltip" title="Insígnia em Destaque: {{ perfil.featured_insignia.nome }}">
                                            {% endif %}
                                        </a>
                                        <br>
                                        <small class="text-muted">{{ perfil.departamento_nome or 'N/D' }}</small>
                                    </td>
                                    <td class="text-end text-warning fs-5"><strong>{{ perfil.score_atual }}</strong> pts</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="streak" role="tabpanel">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <table class="table table-dark table-borderless align-middle ranking-table">
                        <thead><tr><th class="text-center">Posição</th><th colspan="2">Colaborador</th><th class="text-end">Dias Consecutivos</th></tr></thead>
                        <tbody>
                            {% for perfil in ranking_streak %}
                                <tr class="ranking-row {% if perfil.id == current_user_id %}current-user-highlight{% endif %}">
                                    <td class="text-center">
                                        {% if loop.index == 1 %}<span class="rank-position rank-medal gold" title="1º Lugar"><i class="bi bi-trophy-fill"></i></span>{% elif loop.index == 2 %}<span class="rank-position rank-medal silver" title="2º Lugar"><i class="bi bi-trophy-fill"></i></span>{% elif loop.index == 3 %}<span class="rank-position rank-medal bronze" title="3º Lugar"><i class="bi bi-trophy-fill"></i></span>{% else %}<span class="rank-position rank-number">{{ loop.index }}º</span>{% endif %}
                                    </td>
                                    <td style="width: 60px;"><img src="{{ url_for('static', filename=perfil.nivel.badge_icon_url if perfil.nivel else 'img/badges/default.png') }}" class="ranking-avatar"></td>
                                    <td>
                                        {% set is_anonymous_for_others = perfil.is_anonymous and perfil.id != current_user_id %}
                                        {% if is_anonymous_for_others %}
                                            {% set display_name = 'Guardião Anônimo' %}
                                            {% set is_clickable = False %}
                                        {% else %}
                                            {% set is_clickable = True %}
                                            {% if perfil.opt_in_real_name_ranking or not perfil.nickname %}
                                                {% set display_name = perfil.nome %}
                                            {% else %}
                                                {% set display_name = perfil.nickname %}
                                            {% endif %}
                                        {% endif %}
                                        <a href="{% if is_clickable %}{{ url_for('guardians_bp.meu_perfil', perfil_id=perfil.id) }}{% else %}#{% endif %}" 
                                           class="text-white text-decoration-none {% if not is_clickable %}pe-none text-muted{% endif %}">

                                            <strong {% if perfil.name_color and is_clickable %} style="color: {{ perfil.name_color }}; text-shadow: 0 0 5px {{ perfil.name_color }};" {% endif %}>
                                                {{ display_name }}
                                            </strong>

                                            {% if perfil.featured_insignia and is_clickable %}
                                                <img src="{{ url_for('static', filename=perfil.featured_insignia.caminho_imagem) }}" class="featured-insignia-badge" data-bs-toggle="tooltip" title="Insígnia em Destaque: {{ perfil.featured_insignia.nome }}">
                                            {% endif %}
                                        </a>
                                        <br>
                                        <small class="text-muted">{{ perfil.departamento_nome or 'N/D' }}</small>
                                    </td>
                                    <td class="text-end text-warning fs-5">
                                        <strong>
                                            {% if perfil.current_streak and perfil.current_streak|string != 'None' %}{{ perfil.current_streak }}{% else %}0{% endif %}
                                        </strong> dias
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="departamento" role="tabpanel">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <table class="table table-dark table-borderless align-middle ranking-table">
                        <thead><tr><th class="text-center">Posição</th><th>Departamento</th><th class="text-end">Pontuação Total</th></tr></thead>
                        <tbody>
                            {% for depto in ranking_departamento %}
                                <tr class="ranking-row">
                                    <td class="text-center">
                                        {% if loop.index == 1 %}<span class="rank-position rank-medal gold" title="1º Lugar"><i class="bi bi-trophy-fill"></i></span>{% elif loop.index == 2 %}<span class="rank-position rank-medal silver" title="2º Lugar"><i class="bi bi-trophy-fill"></i></span>{% elif loop.index == 3 %}<span class="rank-position rank-medal bronze" title="3º Lugar"><i class="bi bi-trophy-fill"></i></span>{% else %}<span class="rank-position rank-number">{{ loop.index }}º</span>{% endif %}
                                    </td>
                                    <td><i class="bi bi-building-fill me-3 text-muted"></i><strong>{{ depto.departamento_nome or 'Não definido' }}</strong></td>
                                    <td class="text-end text-info fs-5"><strong>{{ depto.score_total }}</strong> pts</td>
                                </tr>
                            {% else %}
                                <tr><td colspan="3" class="text-center text-muted pt-4">Nenhum departamento no ranking.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>

{% endblock %}

