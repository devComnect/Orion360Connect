{% extends "base_template.html" %}
{% block title %}Relatório: {{ perfil.nome }}{% endblock %}

{% block content %}
<div class="container mt-4">
        <a href="{{ url_for('guardians_bp.report_hub') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> Voltar para Seleção
    </a>
    <div class="profile-header mb-4">
        <img src="{{ url_for('static', filename=nivel_atual.badge_icon_url if nivel_atual else 'img/badges/default.png') }}" alt="Insígnia" class="level-badge-img" style="width: 80px; height: 80px;">
        <div class="profile-header-text text-start ms-3">
            <h2 class="profile-header-name text-white mb-0">{{ perfil.nome }}</h2>
            <p class="profile-header-department mb-0">{{ perfil.departamento_nome or 'N/D' }}</p>
        </div>
    </div> 
    
    <div class="row g-4">
        <div class="col-lg-3 col-md-6">
        <div class="analytics-card"><div class="card-icon"><i class="bi bi-star-fill"></i></div>
        <div class="card-value">{{ perfil.score_atual }}</div><div class="card-label">Pontuação Total</div></div></div>
        <div class="col-lg-3 col-md-6">
        <div class="analytics-card"><div class="card-icon"><i class="bi bi-fire"></i></div>
        <div class="card-value">{{ perfil.current_streak or 0 }}</div><div class="card-label">Dias de Vigilante</div></div></div>
        <div class="col-lg-3 col-md-6">
        <div class="analytics-card"><div class="card-icon"><i class="bi bi-patch-question-fill"></i></div>
        <div class="card-value">{{ total_quizzes }}</div><div class="card-label">Quizzes Respondidos</div></div></div>
        <div class="col-lg-3 col-md-6">
        <div class="analytics-card"><div class="card-icon"><i class="bi bi-check2-circle"></i></div><div class="card-value">{{ "%.1f"|format(media_geral_acertos) }}%</div><div class="card-label">Média de Acertos</div></div></div>
    </div>
     
    <hr class="my-5">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button">Histórico de Atividades</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="quizzes-tab" data-bs-toggle="tab" data-bs-target="#quizzes" type="button">Desempenho em Quizzes</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="achievements-tab" data-bs-toggle="tab" data-bs-target="#achievements" type="button">Conquistas</button>
        </li>
    </ul>
    
    <div class="tab-content card bg-dark p-3" id="myTabContent">
        
        <div class="tab-pane fade show active" id="history" role="tabpanel">
            <ul class="list-group list-group-flush">
                {% for acao in user_history %}
                    <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center">
                        <div>{{ acao.descricao }}<br><small class="text-muted">{{ acao.data_evento.strftime('%d/%m/%Y %H:%M') if acao.data_evento else '' }}</small></div>
                        {% if acao.pontuacao != 0 %}<span class="badge {{ 'bg-success' if acao.pontuacao > 0 else 'bg-danger' }} rounded-pill">{{ '+ ' if acao.pontuacao > 0 else '' }}{{ acao.pontuacao }}</span>{% endif %}
                    </li>
                {% else %}
                    <li class="list-group-item bg-dark text-white text-muted text-center">Nenhum evento registrado.</li>
                {% endfor %}
            </ul>
        </div>

        <div class="tab-pane fade" id="quizzes" role="tabpanel">
            <ul class="list-group list-group-flush">
                {% for attempt in user_quiz_attempts %}
                    {# A tag 'a' agora envolve o item da lista, tornando-o clicável #}
                    <a href="{{ url_for('guardians_bp.quiz_analysis', quiz_id=attempt.quiz.id) if attempt.quiz else '#' }}"
                       class="list-group-item list-group-item-action bg-dark text-white d-flex justify-content-between align-items-center">

                        <div>
                            {{ attempt.quiz.title if attempt.quiz else 'Quiz Excluído' }}
                            <br>
                            <small class="text-muted">{% if attempt.completed_at %}{{ attempt.completed_at.strftime('%d/%m/%Y') }}{% else %}Tentativa não finalizada{% endif %}</small>
                        </div>

                        <span class="badge bg-info rounded-pill">{{ attempt.score }} pts</span>
                    </a>
                {% else %}
                    <li class="list-group-item bg-dark text-white text-muted text-center">Nenhum quiz respondido.</li>
                {% endfor %}
            </ul>
        </div>
        
        <div class="tab-pane fade" id="achievements" role="tabpanel">
            <div class="d-flex flex-wrap gap-3 justify-content-center p-3">
                {% for conquista in user_achievements %}
                    <div class="text-center">
                        <img src="{{ url_for('static', filename=conquista.insignia.caminho_imagem) }}"
                             alt="{{ conquista.insignia.nome }}"
                             class="insignia-preview"
                             data-bs-toggle="tooltip" data-bs-placement="top" title="{{ conquista.insignia.descricao }}">
                        <p class="small mt-1 mb-0">{{ conquista.insignia.nome }}</p>
                    </div>
                {% else %}
                    <p class="text-white text-center">Nenhuma conquista desbloqueada.</p>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}