{# ========================================================== #}
{# MACRO PARA O CARD 'LANÇAR EVENTO DE PONTUAÇÃO'             #}
{# ========================================================== #}
{% macro render_lancar_evento(colaboradores, eventos) %}
<div class="card shadow-sm bg-dark text-white h-100">
    <div class="card-header text-center">
        Lançar Evento de Pontuação
    </div>
    <div class="card-body">
        <form action="{{ url_for('guardians_bp.admin') }}" method="POST">
            <input type="hidden" name="action" value="lancar_pontuacao">
            <div class="mb-3">
                <label for="colaborador" class="form-label">Selecione o Colaborador:</label>
                <select class="form-control" id="colaborador" name="colaborador_id" required>
                    {% for colab in colaboradores %}
                        <option value="{{ colab.id }}">{{ colab.nome }} ({{ colab.score_atual }} pontos)</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="evento" class="form-label">Selecione o Evento:</label>
                <select class="form-control" id="evento" name="evento_id" required>
                    {% for evento in eventos %}
                        <option value="{{ evento.id }}">{{ evento.nome }} ({{ evento.pontuacao }} pts)</option>
                    {% endfor %}
                </select>
            </div>
            <div class="text-center">
                <button type="submit" class="btn btn-warning w-100">Lançar Pontuação</button>
            </div>
        </form>
    </div>
</div>
{% endmacro %}


{# ========================================================== #}
{# MACRO PARA O CARD 'GERENCIAR PERFIS'                       #}
{# ========================================================== #}
{% macro render_gestao_perfis(colaboradores) %}
<div class="card shadow-sm bg-dark text-white">
    <div class="card-header text-center">
        Gestão de Perfis de Colaboradores
    </div>
    <div class="card-body">
        <ul class="list-group list-group-flush">
            {% for perfil in colaboradores %}
                <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center flex-wrap">
                    <div class="mb-2">
                        <strong>{{ perfil.nome }}</strong>
                        <br>
                        <small class="text-muted">
                            Depto: {{ perfil.departamento_nome or 'N/D' }} | Pontos: {{ perfil.score_atual or 0 }} | Nível: {{ perfil.nivel.nome if perfil.nivel else 'N/A' }}
                        </small>
                    </div>
                    <div class="btn-group" role="group" aria-label="Ações do Perfil">
                        <a href="{{ url_for('guardians_bp.meu_perfil', perfil_id=perfil.id) }}" class="btn btn-sm btn-outline-primary">Ver</a>
                        
                        {# BOTÃO EDITAR ATUALIZADO COM O NOVO DATA-ATTRIBUTE #}
                        <button type="button" class="btn btn-sm btn-outline-info" 
                                data-bs-toggle="modal" 
                                data-bs-target="#editModalPerfil" 
                                data-id="{{ perfil.id }}" 
                                data-score="{{ perfil.score_atual }}"
                                data-streak="{{ perfil.current_streak or 0 }}"
                                data-is-admin="{{ 'true' if perfil.is_admin else 'false' }}" 
                                data-departamento="{{ perfil.departamento_nome or '' }}" 
                                data-opt-in="{{ 'true' if perfil.opt_in_real_name_ranking else 'false' }}">
                            Editar
                        </button>
                        
                        <form action="{{ url_for('guardians_bp.admin') }}" method="POST" class="d-inline">
                            <input type="hidden" name="action" value="zerar_historico">
                            <input type="hidden" name="perfil_id" value="{{ perfil.id }}">
                            <button type="submit" class="btn btn-sm btn-outline-warning">Zerar</button>
                        </form>
                        
                        {# FORMULÁRIO DE EDITAR OFENSIVA FOI REMOVIDO DAQUI #}
                        
                        <form action="{{ url_for('guardians_bp.admin') }}" method="POST" class="d-inline">
                            <input type="hidden" name="action" value="excluir_perfil">
                            <input type="hidden" name="perfil_id" value="{{ perfil.id }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Excluir</button>
                        </form>
                    </div>
                </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endmacro %}


{# ========================================================== #}
{# MACRO PARA O CARD 'GERENCIAR QUIZZES'                      #}
{# ========================================================== #}
{% macro render_gestao_quizzes(quizzes) %}
<div class="card shadow-sm bg-dark text-white">
    <div class="card-header text-center">
        <i class="bi bi-patch-question-fill me-2"></i> Gestão de Quizzes
    </div>
    <div class="card-body">
        <div class="accordion" id="quizAccordion">
            <div class="accordion-item bg-dark">
                <h2 class="accordion-header" id="headingOne">
                    <button class="accordion-button bg-dark text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCreateQuiz" aria-expanded="true" aria-controls="collapseCreateQuiz">
                        Criar Novo Quiz
                    </button>
                </h2>
                <div id="collapseCreateQuiz" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#quizAccordion">
                    <div class="accordion-body">
                        <form action="{{ url_for('guardians_bp.admin') }}" method="POST">
                            <input type="hidden" name="action" value="criar_quiz">
                            <div class="row">
                                <div class="col-md-6 mb-3"><label class="form-label">Título do Quiz</label><input type="text" name="title" class="form-control" required></div>
                                <div class="col-md-2 mb-3"><label for="quiz-time-limit" class="form-label">Tempo Limite</label><input type="number" name="time_limit_seconds" id="quiz-time-limit" class="form-control" placeholder="Em segundos"></div>
                                <div class="col-md-2 mb-3"><label class="form-label">Categoria</label><select name="category" class="form-control"><option value="COMUM">Comum</option><option value="ESPECIAL">Especial</option><option value="HARDCORE">Hardcore</option></select></div>
                            <div class="row">
                                <div class="col-md-6 mb-3"><label class="form-label">Descrição</label><textarea name="description" class="form-control"></textarea></div>
                                <div class="col-md-2 mb-3"><label class="form-label">Data de Ativação</label><input type="date" name="activation_date" class="form-control" required></div>
                                <div class="col-md-2 mb-3"><label class="form-label">Duração (Dias)</label><input type="number" name="duration_days" class="form-control" value="1" required></div>
                                
                            </div>
                            </div>
                            <hr class="my-4">
                            <h5 class="text-center">Perguntas do Quiz</h5>
                            <div id="questions-container"></div>
                            <button type="button" id="add-question-btn" class="btn btn-outline-info mt-3">Adicionar Pergunta</button>
                            <div class="text-center mt-4"><button type="submit" class="btn btn-warning w-50">Salvar Quiz Completo</button></div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="accordion-item bg-dark">
                <h2 class="accordion-header" id="headingTwo">
                    <button class="accordion-button collapsed bg-dark text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseManageQuizzes" aria-expanded="false" aria-controls="collapseManageQuizzes">
                        Gerenciar Quizzes Existentes
                    </button>
                </h2>
                <div id="collapseManageQuizzes" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#quizAccordion">
                    <div class="accordion-body">
                        <ul class="list-group">
                            {% for quiz in quizzes %}
                                <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center">
                                    <div><strong>{{ quiz.title }}</strong> - <span class="badge bg-secondary">{{ quiz.category.value }}</span><br><small class="text-muted">Ativa em: {{ quiz.activation_date.strftime('%d/%m/%Y') }} por {{ quiz.duration_days }} dia(s)</small></div>
                                    <div>
                                        <a href="{{ url_for('guardians_bp.view_quiz', quiz_id=quiz.id) }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-eye-fill"></i> Visualizar</a>
                                        
                                        <form action="{{ url_for('guardians_bp.admin') }}" method="POST" class="d-inline">
                                            <input type="hidden" name="action" value="excluir_quiz">
                                            <input type="hidden" name="quiz_id" value="{{ quiz.id }}">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Atenção! Isso excluirá o quiz, todas as suas perguntas e o histórico de tentativas. Deseja continuar?')"><i class="bi bi-trash-fill"></i> Excluir</button>
                                        </form>
                                    </div>
                                </li>
                            {% else %}
                                <li class="list-group-item bg-dark text-white">Nenhum quiz cadastrado.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endmacro %}


{# ========================================================== #}
{# MACRO PARA O CARD 'GERENCIAR EVENTOS'                      #}
{# ========================================================== #}
{% macro render_gestao_eventos(eventos) %}
<div class="card shadow-sm bg-dark text-white h-100">
    <div class="card-header text-center">Gerenciar Tipos de Eventos</div>
    <div class="card-body">
        <form action="{{ url_for('guardians_bp.admin') }}" method="POST" class="mb-3">
            <input type="hidden" name="action" value="criar_evento">
            <div class="mb-2"><input type="text" class="form-control" name="nome" placeholder="Nome do evento" required></div>
            <div class="mb-2"><input type="number" class="form-control" name="pontuacao" placeholder="Pontos" required></div>
            <div class="mb-3"><textarea class="form-control" name="descricao" placeholder="Descrição (Opcional)"></textarea></div>
            <div class="text-center"><button class="btn btn-info w-100" type="submit">Adicionar</button></div>
        </form>
        <ul class="list-group list-group-flush">
            {% for evento in eventos %}
                <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center">
                    <div><strong>{{ evento.nome }}</strong><br><small class="text-muted">{{ evento.descricao or 'Sem descrição' }}</small></div>
                    <div>
                        <span class="badge {{ 'bg-success' if evento.pontuacao > 0 else 'bg-danger' }} rounded-pill me-2">{{ evento.pontuacao }} pts</span>
                        <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editModalEvento" data-id="{{ evento.id }}" data-nome="{{ evento.nome }}" data-pontuacao="{{ evento.pontuacao }}" data-descricao="{{ evento.descricao }}">Editar</button>
                        <form action="{{ url_for('guardians_bp.admin') }}" method="POST" class="d-inline">
                            <input type="hidden" name="action" value="excluir_evento">
                            <input type="hidden" name="evento_id" value="{{ evento.id }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Excluir</button>
                        </form>
                    </div>
                </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endmacro %}


{# ========================================================== #}
{# MACRO PARA O CARD 'GERENCIAR NÍVEIS'                       #}
{# ========================================================== #}
{% macro render_gestao_niveis(niveis) %}
<div class="card shadow-sm bg-dark text-white h-100">
    <div class="card-header text-center">Gerenciar Níveis de Segurança</div>
    <div class="card-body">
        <form action="{{ url_for('guardians_bp.admin') }}" method="POST" class="mb-3">
            <input type="hidden" name="action" value="criar_nivel">
            <div class="mb-2"><input type="text" class="form-control" name="nome" placeholder="Nome do nível (ex: Sentinela)" required></div>
            <div class="mb-2"><input type="number" class="form-control" name="score_minimo" placeholder="Pontuação mínima" required></div>
            <div class="mb-3"><input type="text" class="form-control" name="badge_icon_url" placeholder="Caminho da imagem do ícone (ex: img/badges/sentinela.png)" required></div>
            <div class="text-center"><button class="btn btn-info w-100" type="submit">Adicionar Nível</button></div>
        </form>
        <ul class="list-group list-group-flush">
            {% for nivel in niveis %}
                <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center">
                    <div><strong>{{ nivel.nome }}</strong><br><small class="text-muted">Pontos: {{ nivel.score_minimo }}</small></div>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editModalNivel" data-id="{{ nivel.id }}" data-nome="{{ nivel.nome }}" data-score-minimo="{{ nivel.score_minimo }}" data-badge-url="{{ nivel.badge_icon_url }}">Editar</button>
                        <form action="{{ url_for('guardians_bp.admin') }}" method="POST" class="d-inline">
                            <input type="hidden" name="action" value="excluir_nivel">
                            <input type="hidden" name="nivel_id" value="{{ nivel.id }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Excluir</button>
                        </form>
                    </div>
                </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endmacro %}


{# ========================================================== #}
{# MACRO PARA O CARD 'GERENCIAR INSÍGNIAS'                    #}
{# ========================================================== #}
{% macro render_gestao_insignias(insignias, colaboradores) %}
<div class="card shadow-sm bg-dark text-white h-100">
    <div class="card-header text-center">Gerenciar Insígnias e Conquistas</div>
    <div class="card-body d-flex flex-column">
        <form action="{{ url_for('guardians_bp.admin') }}" method="POST" class="mb-3">
            <input type="hidden" name="action" value="criar_insignia">
            <h5 class="text-center mb-3">Criar Nova Insígnia</h5>
            <div class="mb-2"><input type="text" class="form-control" name="nome" placeholder="Nome da conquista" required></div>
            <div class="mb-2"><input type="text" class="form-control" name="descricao" placeholder="Descrição (como obter)"></div>
            <div class="mb-2"><input type="text" class="form-control" name="achievement_code" placeholder="Código de Referência (Ex: SCORE_1000)" id="insignia-code" required></div>
            <div class="mb-2"><input type="text" class="form-control" name="caminho_imagem" placeholder="Caminho da imagem (ex: img/insignias/expert.png)" required></div>
            <div class="mb-3"><input type="number" class="form-control" name="requisito_score" placeholder="Pontuação mínima (opcional)"></div>
            <div class="text-center"><button class="btn btn-info w-100" type="submit">Adicionar Conquista</button></div>
        </form>
        <hr class="my-4">
        <h5 class="text-center mb-3">Insígnias Existentes</h5>
        <div class="flex-grow-1" style="overflow-y: auto; max-height: 300px;">
            <ul class="list-group list-group-flush">
                {% for insignia in insignias %}
                    <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center"><img src="{{ url_for('static', filename=insignia.caminho_imagem) }}" alt="{{ insignia.nome }}" style="width: 40px; height: 40px; margin-right: 15px; border-radius: 5px;"><div><strong>{{ insignia.nome }}</strong><br><small class="text-muted">{{ insignia.descricao or 'Sem descrição' }}</small></div></div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editModalInsignia" data-id="{{ insignia.id }}" data-nome="{{ insignia.nome }}" data-descricao="{{ insignia.descricao or '' }}" data-requisito-score="{{ insignia.requisito_score or '' }}" data-caminho-imagem="{{ insignia.caminho_imagem }}" data-code="{{ insignia.achievement_code }}">Editar</button>
                            <form action="{{ url_for('guardians_bp.admin') }}" method="POST" class="d-inline">
                                <input type="hidden" name="action" value="excluir_insignia">
                                <input type="hidden" name="insignia_id" value="{{ insignia.id }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Tem certeza que deseja excluir esta insígnia? Ela será removida de todos os colaboradores que a conquistaram.')">Excluir</button>
                            </form>
                        </div>
                    </li>
                {% else %}
                    <li class="list-group-item bg-dark text-white text-center">Nenhuma insígnia cadastrada.</li>
                {% endfor %}
            </ul>
        </div>
        <hr class="my-4">

<h5 class="text-center mb-3">Conceder ou Remover Insígnia Manualmente</h5>

{# Usaremos os mesmos seletores para ambas as ações #}
<div class="mb-3">
    <select class="form-control" id="manual-insignia-user-select" required>
        <option value="">Selecione um colaborador</option>
        {% for colab in colaboradores %}
            <option value="{{ colab.id }}">{{ colab.nome }}</option>
        {% endfor %}
    </select>
</div>
<div class="mb-3">
    <select class="form-control" id="manual-insignia-select" required>
        <option value="">Selecione uma insígnia</option>
        {% for ins in insignias %}
            <option value="{{ ins.id }}">{{ ins.nome }}</option>
        {% endfor %}
    </select>
</div>

{# Container para os dois botões/formulários #}
<div class="d-grid gap-2">
    <form action="{{ url_for('guardians_bp.admin') }}" method="POST" class="d-grid">
        <input type="hidden" name="action" value="dar_insignia">
        <input type="hidden" class="manual-insignia-user-input" name="perfil_id">
        <input type="hidden" class="manual-insignia-input" name="insignia_id">
        <button type="submit" class="btn btn-success"><i class="bi bi-plus-circle-fill me-2"></i>Conceder Conquista</button>
    </form>
    
    <form action="{{ url_for('guardians_bp.admin') }}" method="POST" class="d-grid">
        <input type="hidden" name="action" value="remover_insignia">
        <input type="hidden" class="manual-insignia-user-input" name="perfil_id">
        <input type="hidden" class="manual-insignia-input" name="insignia_id">
        <button type="submit" class="btn btn-outline-danger"><i class="bi bi-trash3-fill me-2"></i>Remover Conquista</button>
    </form>
</div>

{# Pequeno script para sincronizar os seletores com os formulários #}
<script>
    const userSelect = document.getElementById('manual-insignia-user-select');
    const insigniaSelect = document.getElementById('manual-insignia-select');
    const allUserInputs = document.querySelectorAll('.manual-insignia-user-input');
    const allInsigniaInputs = document.querySelectorAll('.manual-insignia-input');

    userSelect.addEventListener('change', (e) => {
        allUserInputs.forEach(input => input.value = e.target.value);
    });

    insigniaSelect.addEventListener('change', (e) => {
        allInsigniaInputs.forEach(input => input.value = e.target.value);
    });
</script>
{% endmacro %}


{# ========================================================== #}
{# BLOCO DE MODAIS                                            #}
{# ========================================================== #}
{% macro render_modais() %}
<div class="modal fade" id="editModalEvento" tabindex="-1" aria-labelledby="editModalEventoLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content bg-dark text-white"><div class="modal-header"><h5 class="modal-title" id="editModalEventoLabel">Editar Evento</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><form action="{{ url_for('guardians_bp.admin') }}" method="POST"><div class="modal-body"><input type="hidden" name="action" value="editar_evento"><input type="hidden" name="evento_id" id="edit-evento-id"><div class="mb-3"><label for="edit-nome" class="form-label">Nome do Evento</label><input type="text" class="form-control" id="edit-nome" name="nome" required></div><div class="mb-3"><label for="edit-pontuacao" class="form-label">Pontuação</label><input type="number" class="form-control" id="edit-pontuacao" name="pontuacao" required></div><div class="mb-3"><label for="edit-descricao" class="form-label">Descrição (Opcional)</label><textarea class="form-control" id="edit-descricao" name="descricao"></textarea></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-info">Salvar Alterações</button></div></form></div></div></div>
<div class="modal fade" id="editModalNivel" tabindex="-1" aria-labelledby="editModalNivelLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content bg-dark text-white"><div class="modal-header"><h5 class="modal-title" id="editModalNivelLabel">Editar Nível</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><form action="{{ url_for('guardians_bp.admin') }}" method="POST"><div class="modal-body"><input type="hidden" name="action" value="editar_nivel"><input type="hidden" name="nivel_id" id="edit-nivel-id"><div class="mb-3"><label for="edit-nivel-nome" class="form-label">Nome do Nível</label><input type="text" class="form-control" id="edit-nivel-nome" name="nome" required></div><div class="mb-3"><label for="edit-nivel-score" class="form-label">Pontuação Mínima</label><input type="number" class="form-control" id="edit-nivel-score" name="score_minimo" required></div><div class="mb-3"><label for="edit-nivel-url" class="form-label">Caminho da Imagem do Ícone</label><input type="text" class="form-control" id="edit-nivel-url" name="badge_icon_url" required></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-info">Salvar Alterações</button></div></form></div></div></div>
<div class="modal fade" id="editModalInsignia" tabindex="-1" aria-labelledby="editModalInsigniaLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content bg-dark text-white"><div class="modal-header"><h5 class="modal-title" id="editModalInsigniaLabel">Editar Insígnia</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><form action="{{ url_for('guardians_bp.admin') }}" method="POST"><div class="modal-body"><input type="hidden" name="action" value="editar_insignia"><input type="hidden" name="insignia_id" id="edit-insignia-id"><div class="mb-3"><label for="edit-insignia-nome" class="form-label">Nome da Conquista</label><input type="text" class="form-control" id="edit-insignia-nome" name="nome" required></div><div class="mb-3"><label for="edit-insignia-code" class="form-label">Código de Referência</label><input type="text" class="form-control" id="edit-insignia-code" name="achievement_code" required></div><div class="mb-3"><label for="edit-insignia-descricao" class="form-label">Descrição</label><textarea class="form-control" id="edit-insignia-descricao" name="descricao"></textarea></div><div class="mb-3"><label for="edit-insignia-score" class="form-label">Pontuação Mínima</label><input type="number" class="form-control" id="edit-insignia-score" name="requisito_score"></div><div class="mb-3"><label for="edit-insignia-url" class="form-label">Caminho da Imagem</label><input type="text" class="form-control" id="edit-insignia-url" name="caminho_imagem" required></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-info">Salvar Alterações</button></div></form></div></div></div>
<div class="modal fade" id="editModalPerfil" tabindex="-1" aria-labelledby="editModalPerfilLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalPerfilLabel">Editar Perfil de <span id="perfil-nome"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <form action="{{ url_for('guardians_bp.admin') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="action" value="editar_perfil"> 
                    <input type="hidden" name="perfil_id" id="edit-perfil-id">

                    <div class="mb-3">
                        <label for="edit-score-atualizado" class="form-label">Pontuação Atualizada</label>
                        <input type="number" class="form-control" id="edit-score-atualizado" name="score_atual" required>
                    </div>

                    <div class="mb-3">
                        <label for="edit-streak" class="form-label">Dias de Vigilante (Ofensiva)</label>
                        <input type="number" class="form-control" id="edit-streak" name="current_streak" min="0">
                    </div>

                    <div class="mb-3">
                        <label for="edit-departamento" class="form-label">Departamento</label>
                        <input type="text" class="form-control" id="edit-departamento" name="departamento" required>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="edit-is-admin" name="is_admin">
                        <label class="form-check-label" for="edit-is-admin">Permissão de Admin</label>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="edit-opt-in-ranking" name="opt_in_ranking">
                        <label class="form-check-label" for="edit-opt-in-ranking">Optar por exibir nome no ranking</label>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info">Salvar Alterações</button> 
                </div>
            </form>

        </div>
    </div>
</div>
{% endmacro %}


{# ==================================================================== #}
{# BLOCO DE SCRIPTS E TEMPLATES DE QUIZ                                 #}
{# ==================================================================== #}
{% macro render_quiz_assets() %}
    <div id="question-template" style="display: none;">
        <div class="question-block card card-body bg-secondary text-white mb-3">
            <button type="button" class="btn-close btn-close-white remove-question-btn" style="position: absolute; top: 10px; right: 10px;"></button>
            <div class="row">
                <div class="col-md-9"><label class="form-label">Texto da Pergunta</label><textarea name="questions[INDEX][question_text]" class="form-control" rows="2" required></textarea></div>
                <div class="col-md-3"><label class="form-label">Pontos</label><input type="number" name="questions[INDEX][points]" class="form-control" value="10" required></div>
            </div>
            <div class="options-container mt-3"></div>
            <button type="button" class="btn btn-sm btn-light add-option-btn mt-2" style="max-width: 150px;">Adicionar Opção</button>
        </div>
    </div>
    <div id="option-template" style="display: none;">
        <div class="input-group mb-2 option-block">
            <div class="input-group-text bg-dark"><input class="form-check-input mt-0" type="radio" name="questions[Q_INDEX][correct_option]" value="O_INDEX" required></div>
            <input type="text" name="questions[Q_INDEX][options][O_INDEX][option_text]" class="form-control" placeholder="Texto da resposta" required>
            <button class="btn btn-outline-danger remove-option-btn" type="button">X</button>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        
        // --- LÓGICA PARA POPULAR O MODAL DE EVENTOS ---
        var editModalEvento = document.getElementById('editModalEvento');
        if (editModalEvento) {
            editModalEvento.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var eventoId = button.getAttribute('data-id');
                var eventoNome = button.getAttribute('data-nome');
                var eventoPontuacao = button.getAttribute('data-pontuacao');
                var eventoDescricao = button.getAttribute('data-descricao');
                editModalEvento.querySelector('#edit-evento-id').value = eventoId;
                editModalEvento.querySelector('#edit-nome').value = eventoNome;
                editModalEvento.querySelector('#edit-pontuacao').value = eventoPontuacao;
                editModalEvento.querySelector('#edit-descricao').value = eventoDescricao;
            });
        }

        // --- LÓGICA PARA POPULAR O MODAL DE NÍVEIS ---
        var editModalNivel = document.getElementById('editModalNivel');
        if (editModalNivel) {
            editModalNivel.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var nivelId = button.getAttribute('data-id');
                var nivelNome = button.getAttribute('data-nome');
                var nivelScore = button.getAttribute('data-score-minimo');
                var nivelUrl = button.getAttribute('data-badge-url');
                editModalNivel.querySelector('#edit-nivel-id').value = nivelId;
                editModalNivel.querySelector('#edit-nivel-nome').value = nivelNome;
                editModalNivel.querySelector('#edit-nivel-score').value = nivelScore;
                editModalNivel.querySelector('#edit-nivel-url').value = nivelUrl;
            });
        }

        // --- LÓGICA PARA POPULAR O MODAL DE INSÍGNIAS (CONQUISTAS) ---
        var editModalInsignia = document.getElementById('editModalInsignia');
        if (editModalInsignia) {
            editModalInsignia.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var insigniaId = button.getAttribute('data-id');
                var insigniaNome = button.getAttribute('data-nome');
                var insigniaDescricao = button.getAttribute('data-descricao');
                var insigniaScore = button.getAttribute('data-requisito-score');
                var insigniaUrl = button.getAttribute('data-caminho-imagem');
                var insigniaCode = button.getAttribute('data-code'); // Pega o novo código
                
                editModalInsignia.querySelector('#edit-insignia-id').value = insigniaId;
                editModalInsignia.querySelector('#edit-insignia-nome').value = insigniaNome;
                editModalInsignia.querySelector('#edit-insignia-descricao').value = insigniaDescricao;
                editModalInsignia.querySelector('#edit-insignia-score').value = insigniaScore;
                editModalInsignia.querySelector('#edit-insignia-url').value = insigniaUrl;
                editModalInsignia.querySelector('#edit-insignia-code').value = insigniaCode; // Preenche o novo campo
            });
        }

        // --- LÓGICA PARA POPULAR O MODAL DE PERFIS ---
        var editModalPerfil = document.getElementById('editModalPerfil');
        if (editModalPerfil) {
            editModalPerfil.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var perfilId = button.getAttribute('data-id');
                var perfilNome = button.closest('li').querySelector('strong').textContent;
                var perfilScore = button.getAttribute('data-score');
                var perfilStreak = button.getAttribute('data-streak');
                var perfilIsAdmin = button.getAttribute('data-is-admin') === 'true';
                var perfilDepartamento = button.getAttribute('data-departamento');
                var perfilOptIn = button.getAttribute('data-opt-in') === 'true';
                
                editModalPerfil.querySelector('#edit-perfil-id').value = perfilId;
                editModalPerfil.querySelector('#perfil-nome').textContent = perfilNome;
                editModalPerfil.querySelector('#edit-score-atualizado').value = perfilScore;
                editModalPerfil.querySelector('#edit-streak').value = perfilStreak;
                editModalPerfil.querySelector('#edit-departamento').value = perfilDepartamento;
                editModalPerfil.querySelector('#edit-is-admin').checked = perfilIsAdmin;
                editModalPerfil.querySelector('#edit-opt-in-ranking').checked = perfilOptIn;
            });
        }

        // --- LÓGICA DO CONSTRUTOR DE QUIZZES ---
        const questionsContainer = document.getElementById('questions-container');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const questionTemplate = document.getElementById('question-template');
        const optionTemplate = document.getElementById('option-template');
        let questionIndex = 0;

        if (addQuestionBtn) {
            addQuestionBtn.addEventListener('click', addQuestion);
            questionsContainer.addEventListener('click', function (e) {
                if (e.target && e.target.classList.contains('remove-question-btn')) { e.target.closest('.question-block').remove(); }
                if (e.target && e.target.classList.contains('remove-option-btn')) { e.target.closest('.option-block').remove(); }
                if (e.target && e.target.classList.contains('add-option-btn')) { addOption(e.target); }
            });
            
            function addQuestion() {
                const newQuestion = questionTemplate.firstElementChild.cloneNode(true);
                newQuestion.innerHTML = newQuestion.innerHTML.replace(/INDEX/g, questionIndex);
                newQuestion.dataset.optionIndex = 0; 
                questionsContainer.appendChild(newQuestion);
                addOption(newQuestion.querySelector('.add-option-btn'));
                addOption(newQuestion.querySelector('.add-option-btn'));
                questionIndex++;
            }

            function addOption(button) {
                const questionBlock = button.closest('.question-block');
                const optionsContainer = questionBlock.querySelector('.options-container');
                const currentQIndex = Array.from(questionsContainer.children).indexOf(questionBlock);
                let optionIndex = parseInt(questionBlock.dataset.optionIndex);
                const newOption = optionTemplate.firstElementChild.cloneNode(true);
                let newOptionHTML = newOption.innerHTML.replace(/Q_INDEX/g, currentQIndex);
                newOptionHTML = newOptionHTML.replace(/O_INDEX/g, optionIndex);
                newOption.innerHTML = newOptionHTML;
                optionsContainer.appendChild(newOption);
                questionBlock.dataset.optionIndex = optionIndex + 1;
            }
            
            if (questionsContainer && questionsContainer.children.length === 0) {
                addQuestion();
            }
        }
    });
    </script>
{% endmacro %}