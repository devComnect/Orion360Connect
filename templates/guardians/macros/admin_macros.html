{# ========================================================== #}
{# MACRO PARA O CARD 'LANÇAR EVENTO DE PONTUAÇÃO'             #}
{# ========================================================== #}
{% macro render_lancar_evento(colaboradores, eventos) %}
<div class="card shadow-sm bg-dark text-white h-100">
    <div class="card-header text-center">
        Lançar Evento de Pontuação
    </div>
    <div class="card-body">
        <form action="{{ url_for('admin_v2_bp.content_hub') }}" method="POST">
            <input type="hidden" name="action" value="lancar_pontuacao">
            <div class="mb-3">
                <label for="colaborador" class="form-label">Selecione o Colaborador:</label>
                <select class="form-control" id="colaborador" name="colaborador_id" required>
                    {% for colab in colaboradores %}
                        <option value="{{ colab.id }}">{{ colab.nome }} ({{ colab.score_atual }} pontos)</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="evento" class="form-label">Selecione o Evento:</label>
                <select class="form-control" id="evento" name="evento_id" required>
                    {% for evento in eventos %}
                        <option value="{{ evento.id }}">{{ evento.nome }} ({{ evento.pontuacao }} pts)</option>
                    {% endfor %}
                </select>
            </div>
            <div class="text-center">
                <button type="submit" class="btn btn-warning w-100">Lançar Pontuação</button>
            </div>
        </form>
    </div>
</div>
{% endmacro %}



{# ========================================================== #}
{# MACRO PARA O CARD 'GERENCIAR ANAGRAMA'                      #}
{# ========================================================== #}
{% macro render_gestao_anagrama(anagram_games) %}
    <div class="card bg-dark text-white shadow mb-4">
        <div class="card-header"><h4>Criar Pacote de Anagramas</h4></div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('admin_v2_bp.content_hub') }}#tab-anagram">
                <input type="hidden" name="action" value="create_anagram_game">
                <div class="row g-3">
                    <div class="col-md-4"><label>Título</label><input type="text" name="title" class="form-control" required></div>
                    <div class="col-md-2"><label>Pts/Palavra</label><input type="number" name="points_per_word" value="5" class="form-control" required></div>
                    <div class="col-md-2"><label>Tempo em s</label><input type="number" name="time_limit_seconds" class="form-control" placeholder="Opcional"></div>
                    <div class="col-md-6"><label class="form-label">Data de Ativação</label><input type="date" class="form-control" name="activation_date" value="{{ date.today().isoformat() }}" required></div>
                    <div class="col-md-6"><label class="form-label">Duração (dias)</label><input type="number" class="form-control" name="duration_days" value="7" placeholder="Ex: 7 (para 1 semana)" required></div>
                    <div class="col-md-12"><label>Descrição</label><input type="text" name="description" class="form-control"></div>
                    <div class="col-12"><button type="submit" class="btn btn-primary">Criar Pacote</button></div>
                    <div class="col-12"><button class="btn btn-sm btn-success me-2" data-bs-toggle="modal" data-bs-target="#importAnagramCsvModal">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Importar CSV
                    </button></div>
                </div>
            </form>
        </div>
    </div>
    <div class="card bg-dark text-white shadow">
        <div class="card-header"><h4>Pacotes Criados</h4></div>
        <div class="card-body">
            <table class="table table-dark table-hover">
                <thead><tr><th>Título</th><th>Status</th><th>Palavras</th><th>Pontos</th></tr></thead>
                <tbody>
                    {% for game in anagram_games %}
                    <tr>
                        <td>{{ game.title }}</td>
                        <td>{% if game.is_active %}<span class="badge bg-success">Ativo</span>{% else %}<span class="badge bg-secondary">Inativo</span>{% endif %}</td>
                        <td>{{ game.words|length }}</td>
                        <td>{{ game.points_per_word }}</td>
                        <td class="text-end">
                            <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#manageWordsModal-{{ game.id }}"><i class="bi bi-pencil-square"></i> Palavras ({{ game.words|length }})</button>
                            <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editAnagramModal-{{ game.id }}"><i class="bi bi-pencil"></i> Editar</button>
                            <form method="POST" action="{{ url_for('admin_v2_bp.content_hub') }}#tab-anagram" style="display:inline;" onsubmit="return confirm('ATENÇÃO: A exclusão é permanente e só funcionará se o jogo não tiver tentativas. Deseja continuar?');">
                                <input type="hidden" name="action" value="delete_anagram_game">
                                <input type="hidden" name="game_id" value="{{ game.id }}">
                                <button type="submit" class="btn btn-danger btn-sm"><i class="bi bi-trash"></i></button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="modal fade" id="importAnagramCsvModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <form action="{{ url_for('admin_v2_bp.content_hub') }}#tab-anagram" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="action" value="import_anagram_csv">
                    <div class="modal-header"><h5 class="modal-title">Importar Anagramas (CSV)</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <div class="alert alert-info small">
                            <strong>Lógica de Agrupamento:</strong> O sistema cria um jogo para cada "Título" único e adiciona todas as palavras associadas a ele.
                        </div>
                        <p class="small text-muted">Colunas: Título, Descrição, Data, Dias, Tempo, Pts/Palavra, PALAVRA</p>
                        <input type="file" name="csv_file" class="form-control" accept=".csv" required>
                    </div>
                    <div class="modal-footer"><button type="submit" class="btn btn-success">Importar</button></div>
                </form>
            </div>
        </div>
    </div>
{% endmacro %}
{% macro render_anagram_word_modals(anagram_games) %}
    {# Cria um modal separado para CADA jogo na lista #}
    {% if anagram_games %}
        {% for game in anagram_games %}
        <div class="modal fade modal-lg" id="manageWordsModal-{{ game.id }}" tabindex="-1" aria-labelledby="manageWordsModalLabel-{{ game.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content bg-dark text-white">
                    <div class="modal-header">
                        <h5 class="modal-title" id="manageWordsModalLabel-{{ game.id }}">Gerenciar Palavras: {{ game.title }}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        
                        <form method="POST" action="{{ url_for('admin_v2_bp.content_hub') }}#tab-anagram" class="mb-4">
                            <input type="hidden" name="action" value="add_anagram_word">
                            <input type="hidden" name="game_id" value="{{ game.id }}">
                            
                            <label for="modal-word-text-{{ game.id }}" class="form-label">
                                Adicionar Palavras:
                                <span class="text-muted small ms-2">(Use " ; " para separar várias palavras)</span>
                            </label>
                            
                            <div class="input-group">
                                <input type="text" class="form-control" name="word_text" 
                                    id="modal-word-text-{{ game.id }}" 
                                    placeholder="Ex: FIREWALL ; SERVER ; DADOS" required>
                                
                                <button class="btn btn-primary" type="submit">
                                    <i class="bi bi-plus-lg"></i> Adicionar
                                </button>
                            </div>
                            <div class="form-text text-white-50">Mínimo de 3 letras, apenas caracteres alfabéticos.</div>
                        </form>
                        
                        <hr>
                        
                        <h6 class="text-info">Palavras Atuais ({{ game.words|length }})</h6>
                        {% if game.words %}
                            <ul class="list-group list-group-flush">
                                {% for word in game.words|sort(attribute='correct_word') %}
                                <li class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center px-0">
                                    <span>{{ word.correct_word }}</span>
                                    <form method="POST" action="{{ url_for('admin_v2_bp.content_hub') }}#tab-anagram" onsubmit="return confirm('Excluir palavra \'{{ word.correct_word }}\'?');">
                                        <input type="hidden" name="action" value="delete_anagram_word">
                                        <input type="hidden" name="word_id" value="{{ word.id }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir Palavra">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted text-center">Nenhuma palavra adicionada a este pacote.</p>
                        {% endif %}

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% endif %}
{% endmacro %}

{# ========================================================== #}
{# MACRO PARA O CARD 'GERENCIAR TERMO'                      #}
{# ========================================================== #}
{% macro render_gestao_termo(termo_games) %}
    <div class="card bg-dark text-white shadow mb-4">
        <div class="card-header"><h4><i class="bi bi-plus-square-dotted me-2"></i> Criar Novo Jogo Termo</h4></div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('admin_v2_bp.content_hub') }}#tab-termo">
                <input type="hidden" name="action" value="create_termo_game">
                <div class="row g-3">
                    <div class="col-md-3"><label class="form-label">Palavra Correta</label><input type="text" class="form-control" name="correct_word" required></div>
                    <div class="col-md-3"><label class="form-label">Dica (Opcional)</label><input type="text" class="form-control" name="hint" placeholder="Ex: Relacionado a hardware..."></div>
                    <div class="col-md-3"><label class="form-label">Nº de Tentativas</label><input type="number" class="form-control" name="max_attempts" value="6" required></div>
                    <div class="col-md-3"><label class="form-label">Pts</label><input type="number" class="form-control" name="points_reward" value="10" required></div>
                    <div class="col-md-3"><label class="form-label">Tempo em s</label><input type="number" class="form-control" name="time_limit_seconds" placeholder="Opcional"></div>
                    <div class="col-md-6"><label class="form-label">Data de Ativação</label><input type="date" class="form-control" name="activation_date" value="{{ date.today().isoformat() }}" required></div>
                    <div class="col-md-6"><label class="form-label">Duração (dias)</label><input type="number" class="form-control" name="duration_days" value="7" placeholder="Ex: 7 (para 1 semana)" required></div>
                    <div class="col-12"><button type="submit" class="btn btn-primary">Criar Jogo</button></div>
                    <div class="col-12"><button class="btn btn-sm btn-success me-2" data-bs-toggle="modal" data-bs-target="#importTermoCsvModal">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Importar CSV
                    </button></div>
                    
                </div>
            </form>
        </div>
    </div>

    <div class="card bg-dark text-white shadow">
        <div class="card-header"><h4><i class="bi bi-grid-3x3-gap me-2"></i> Jogos Criados</h4></div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Palavra</th>
                            <th class="text-center">Tentativas</th>
                            <th class="text-center">Pontos</th>
                            <th class="text-center">Ativo?</th>
                            <th>Data de Criação</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for game in termo_games %}
                        <tr>
                            <td><strong>* * * * * * * *</strong></td>
                            <td class="text-center">{{ game.max_attempts }}</td>
                            <td class="text-center">{{ game.points_reward }}</td>
                            <td class="text-center">
                                {% if game.is_active %}
                                    <span class="badge bg-success">Sim</span>
                                {% else %}
                                    <span class="badge bg-secondary">Não</span>
                                {% endif %}
                            </td>
                            <td>{{ game.created_at.strftime('%d/%m/%Y') }}</td>
                            <td class="text-end">
                                <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editTermoGameModal-{{ game.id }}" title="Editar Jogo">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <form method="POST" action="{{ url_for('admin_v2_bp.content_hub') }}#tab-termo" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja excluir este jogo? A ação só funcionará se ninguém o tiver jogado.');">
                                    <input type="hidden" name="action" value="delete_termo_game">
                                    <input type="hidden" name="game_id" value="{{ game.id }}">
                                    <button type="submit" class="btn btn-danger btn-sm" title="Excluir Jogo">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="importTermoCsvModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <form action="{{ url_for('admin_v2_bp.content_hub') }}#tab-termo" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="action" value="import_termo_csv">
                    <div class="modal-header"><h5 class="modal-title">Importar Termo (CSV)</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <p class="small text-muted">Colunas: Palavra, Dica, Data(Y-m-d), Dias, Tentativas, Pontos, Tempo(s)</p>
                        <input type="file" name="csv_file" class="form-control" accept=".csv" required>
                    </div>
                    <div class="modal-footer"><button type="submit" class="btn btn-success">Importar</button></div>
                </form>
            </div>
        </div>
    </div>
{% endmacro %}

{# ========================================================== #}
{# MACRO PARA O CARD 'GERENCIAR PASSWORD'                      #}
{# ========================================================== #}
{% macro render_gestao_password(password_config, password_rules) %}
    <div class="row">
        <div class="col-md-5">
            <div class="card bg-dark text-white border-secondary h-100">
                <div class="card-header"><h4><i class="bi bi-sliders"></i> Configuração do Motor</h4></div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin_v2_bp.content_hub') }}#tab-password">
                        <input type="hidden" name="action" value="config_password_game">
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" name="is_active" id="pwd-active" {% if password_config.is_active %}checked{% endif %}>
                            <label class="form-check-label" for="pwd-active">Minigame Ativo (Mestre)</label>
                        </div>

                        <div class="mb-4 p-3 border border-secondary rounded bg-opacity-10 bg-secondary">
                            <label class="form-label text-info mb-2"><i class="bi bi-calendar-week"></i> Disponibilidade Semanal</label>
                            <div class="d-flex flex-wrap gap-3">
                                {% set dias_semana = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'] %}
                                {# Converte a string salva "0,2,4" em uma lista para verificar #}
                                {% set active_days_list = password_config.active_days.split(',') if password_config.active_days else [] %}
                                
                                {% for i in range(7) %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="active_days" value="{{ i }}" id="day-{{ i }}" 
                                        {% if i|string in active_days_list %}checked{% endif %}>
                                    <label class="form-check-label small" for="day-{{ i }}">{{ dias_semana[i] }}</label>
                                </div>
                                {% endfor %}
                            </div>
                            <small class="text-muted" style="font-size: 0.75rem;">Se nenhum for marcado, o jogo não abrirá nunca.</small>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Tempo (s)</label>
                                <input type="number" name="time_limit" class="form-control" value="{{ password_config.time_limit_seconds }}">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Recompensa</label>
                                <input type="number" name="base_reward" class="form-control" value="{{ password_config.base_reward_points }}">
                            </div>
                        </div>

                        <hr class="border-secondary">
                        <h6 class="text-info mb-3">Balanceamento (Regras por Jogo)</h6>
                        
                        <div class="row g-2">
                            <div class="col-3">
                                <label class="small text-muted">Fácil</label>
                                <input type="number" name="count_easy" class="form-control form-control-sm" value="{{ password_config.rules_count_easy }}" min="0">
                            </div>
                            <div class="col-3">
                                <label class="small text-muted">Médio</label>
                                <input type="number" name="count_medium" class="form-control form-control-sm" value="{{ password_config.rules_count_medium }}" min="0">
                            </div>
                            <div class="col-3">
                                <label class="small text-muted">Difícil</label>
                                <input type="number" name="count_hard" class="form-control form-control-sm" value="{{ password_config.rules_count_hard }}" min="0">
                            </div>
                            <div class="col-3">
                                <label class="small text-muted">Insano</label>
                                <input type="number" name="count_insane" class="form-control form-control-sm" value="{{ password_config.rules_count_insane }}" min="0">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mt-4">Salvar Configurações</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card bg-dark text-white border-secondary h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>Banco de Regras (Regex)</h4>
                    <span class="badge bg-secondary">{{ password_rules|length }} Regras</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-dark table-hover mb-0">
                            <thead class="table-light text-dark" style="position: sticky; top: 0;">
                                <tr>
                                    <th>ID</th>
                                    <th>Dificuldade</th>
                                    <th>Descrição</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rule in password_rules %}
                                <tr>
                                    <td><code>{{ rule.id }}</code></td>
                                    <td>
                                        {% if rule.diff == 'easy' %}<span class="badge bg-success">Fácil</span>
                                        {% elif rule.diff == 'medium' %}<span class="badge bg-warning text-dark">Médio</span>
                                        {% elif rule.diff == 'hard' %}<span class="badge bg-danger">Difícil</span>
                                        {% else %}<span class="badge bg-dark border border-danger text-danger">Insano</span>{% endif %}
                                    </td>
                                    <td>{{ rule.desc }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endmacro %}


{# ========================================================== #}
{# MACRO PARA O CARD 'GERENCIAR EVENTOS'                      #}
{# ========================================================== #}
{% macro render_gestao_eventos(eventos) %}
<div class="card shadow-sm bg-dark text-white h-100">
    <div class="card-header text-center">Gerenciar Tipos de Eventos</div>
    <div class="card-body">
        <form action="{{ url_for('admin_v2_bp.content_hub') }}" method="POST" class="mb-3">
            <input type="hidden" name="action" value="criar_evento">
            <div class="mb-2"><input type="text" class="form-control" name="nome" placeholder="Nome do evento" required></div>
            <div class="mb-2"><input type="number" class="form-control" name="pontuacao" placeholder="Pontos" required></div>
            <div class="mb-3"><textarea class="form-control" name="descricao" placeholder="Descrição (Opcional)"></textarea></div>
            <div class="text-center"><button class="btn btn-info w-100" type="submit">Adicionar</button></div>
        </form>
        <ul class="list-group list-group-flush">
            {% for evento in eventos %}
                <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center">
                    <div><strong>{{ evento.nome }}</strong><br><small class="text-muted">{{ evento.descricao or 'Sem descrição' }}</small></div>
                    <div>
                        <span class="badge {{ 'bg-success' if evento.pontuacao > 0 else 'bg-danger' }} rounded-pill me-2">{{ evento.pontuacao }} pts</span>
                        <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editModalEvento" data-id="{{ evento.id }}" data-nome="{{ evento.nome }}" data-pontuacao="{{ evento.pontuacao }}" data-descricao="{{ evento.descricao }}">Editar</button>
                        <form action="{{ url_for('admin_v2_bp.content_hub') }}" method="POST" class="d-inline">
                            <input type="hidden" name="action" value="excluir_evento">
                            <input type="hidden" name="evento_id" value="{{ evento.id }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Excluir</button>
                        </form>
                    </div>
                </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endmacro %}


{# ========================================================== #}
{# MACRO PARA O CARD 'GERENCIAR INSÍGNIAS'                    #}
{# ========================================================== #}
{% macro render_gestao_insignias(insignias, colaboradores) %}
<div class="card shadow-sm bg-dark text-white h-100">
    <div class="card-header text-center">Gerenciar Insígnias e Conquistas</div>
    <div class="card-body d-flex flex-column">
        <form action="{{ url_for('admin_v2_bp.content_hub') }}" method="POST" class="mb-3">
            <input type="hidden" name="action" value="criar_insignia">
            <h5 class="text-center mb-3">Criar Nova Insígnia</h5>
            <div class="mb-2"><input type="text" class="form-control" name="nome" placeholder="Nome da conquista" required></div>
            <div class="mb-2"><input type="text" class="form-control" name="descricao" placeholder="Descrição (como obter)"></div>
            <div class="mb-2"><input type="text" class="form-control" name="achievement_code" placeholder="Código de Referência (Ex: SCORE_1000)" id="insignia-code" required></div>
            <div class="mb-2"><input type="text" class="form-control" name="caminho_imagem" placeholder="Caminho da imagem (ex: img/insignias/expert.png)" required></div>
            <div class="mb-3"><input type="number" class="form-control" name="requisito_score" placeholder="Pontuação mínima (opcional)"></div>
            <div class="text-center"><button class="btn btn-info w-100" type="submit">Adicionar Conquista</button></div>
        </form>
        <hr class="my-4">
        <h5 class="text-center mb-3">Insígnias Existentes</h5>
        <div class="flex-grow-1" style="overflow-y: auto; max-height: 300px;">
            <ul class="list-group list-group-flush">
                {% for insignia in insignias %}
                    <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center"><img src="{{ url_for('static', filename=insignia.caminho_imagem) }}" alt="{{ insignia.nome }}" style="width: 40px; height: 40px; margin-right: 15px; border-radius: 5px;"><div><strong>{{ insignia.nome }}</strong><br><small class="text-muted">{{ insignia.descricao or 'Sem descrição' }}</small></div></div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editModalInsignia" data-id="{{ insignia.id }}" data-nome="{{ insignia.nome }}" data-descricao="{{ insignia.descricao or '' }}" data-requisito-score="{{ insignia.requisito_score or '' }}" data-caminho-imagem="{{ insignia.caminho_imagem }}" data-code="{{ insignia.achievement_code }}" data-bonus-type="{{ insignia.bonus_type or '' }}" data-bonus-value="{{ insignia.bonus_value or '' }}">Editar</button>
                            <form action="{{ url_for('admin_v2_bp.content_hub') }}" method="POST" class="d-inline">
                                <input type="hidden" name="action" value="excluir_insignia">
                                <input type="hidden" name="insignia_id" value="{{ insignia.id }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Tem certeza que deseja excluir esta insígnia? Ela será removida de todos os colaboradores que a conquistaram.')">Excluir</button>
                            </form>
                        </div>
                    </li>
                {% else %}
                    <li class="list-group-item bg-dark text-white text-center">Nenhuma insígnia cadastrada.</li>
                {% endfor %}
            </ul>
        </div>
        <hr class="my-4">

{% endmacro %}



{# ========================================================== #}
{# BLOCO DE MODAIS                                            #}
{# ========================================================== #}
{% macro render_modais(specializations, niveis=None, eventos=None, insignias=None, colaboradores=None, termo_games=None, anagram_games=None) %}

    {% for game in anagram_games %}
    <div class="modal fade" id="editAnagramModal-{{ game.id }}" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <form method="POST" action="{{ url_for('admin_v2_bp.content_hub') }}">
                    <input type="hidden" name="action" value="edit_anagram_game">
                    <input type="hidden" name="game_id" value="{{ game.id }}">
                    <div class="modal-header"><h5 class="modal-title">Editar: {{ game.title }}</h5>...</div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-12"><label>Título</label><input type="text" name="title" class="form-control" value="{{ game.title }}" required></div>
                            <div class="col-md-6"><label>Pts/Palavra</label><input type="number" name="points_per_word" value="{{ game.points_per_word }}" class="form-control" required></div>
                            <div class="col-md-6"><label>Tempo em s</label><input type="number" name="time_limit_seconds" class="form-control" value="{{ game.time_limit_seconds or '' }}" placeholder="Opcional"></div>
                            <div class="col-md-6"><label class="form-label">Data de Ativação</label><input type="date" class="form-control" name="activation_date" value="{{ game.activation_date.isoformat() if game.activation_date else '' }}" required></div>
                            <div class="col-md-6"><label class="form-label">Duração (dias)</label><input type="number" class="form-control" name="duration_days" value="{{ game.duration_days or 7 }}" required></div>
                            <div class="col-md-12"><label>Descrição</label><input type="text" name="description" class="form-control" value="{{ game.description or '' }}"></div>
                            <div class="col-12"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="is_active" {% if game.is_active %}checked{% endif %}><label class="form-check-label">Jogo Ativo</label></div></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}

    {% for game in termo_games %}
    <div class="modal fade" id="editTermoGameModal-{{ game.id }}" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <form method="POST" action="{{ url_for('admin_v2_bp.content_hub') }}">
                    <input type="hidden" name="action" value="edit_termo_game">
                    <input type="hidden" name="game_id" value="{{ game.id }}">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Jogo: {{ game.correct_word }}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6"><label class="form-label">Palavra Correta</label><input type="text" class="form-control" name="correct_word" value="{{ game.correct_word }}" required></div>
                            <div class="col-md-6"><label class="form-label">Dica (Opcional)</label><input type="text" class="form-control" name="hint" value="{{ game.hint }}"></div>
                            <div class="col-md-6"><label class="form-label">Nº de Tentativas</label><input type="number" class="form-control" name="max_attempts" value="{{ game.max_attempts }}" required></div>
                            <div class="col-md-6"><label class="form-label">Pts</label><input type="number" class="form-control" name="points_reward" value="{{ game.points_reward }}" required></div>
                            <div class="col-md-6"><label class="form-label">Tempo</label><input type="number" class="form-control" name="time_limit_seconds" value="{{ game.time_limit_seconds or '' }}" placeholder="Opcional, em segundos"></div>
                            <div class="col-md-6"><label class="form-label">Data de Ativação</label><input type="date" class="form-control" name="activation_date" value="{{ date.today().isoformat() }}" required></div>
                            <div class="col-md-6"><label class="form-label">Duração (dias)</label><input type="number" class="form-control" name="duration_days" value="7" placeholder="Ex: 7 (para 1 semana)" required></div>
                            <div class="col-12"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="is_active" id="is_active-{{ game.id }}" {% if game.is_active %}checked{% endif %}><label class="form-check-label" for="is_active-{{ game.id }}">Jogo Ativo</label></div></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}

    <div class="modal fade" id="editModalEvento" tabindex="-1" aria-labelledby="editModalEventoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalEventoLabel">Editar Evento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('admin_v2_bp.content_hub') }}" method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="editar_evento">
                        <input type="hidden" name="evento_id" id="edit-evento-id">
                        <div class="mb-3"><label for="edit-nome" class="form-label">Nome do Evento</label><input type="text" class="form-control" id="edit-nome" name="nome" required></div>
                        <div class="mb-3"><label for="edit-pontuacao" class="form-label">Pontuação</label><input type="number" class="form-control" id="edit-pontuacao" name="pontuacao" required></div>
                        <div class="mb-3"><label for="edit-descricao" class="form-label">Descrição (Opcional)</label><textarea class="form-control" id="edit-descricao" name="descricao"></textarea></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-info">Salvar Alterações</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
 
	<div class="modal fade" id="editModalInsignia" tabindex="-1" aria-labelledby="editModalInsigniaLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content bg-dark text-white">
				<div class="modal-header">
					<h5 class="modal-title" id="editModalInsigniaLabel">Editar Insígnia</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<form action="{{ url_for('admin_v2_bp.content_hub') }}" method="POST">
					<div class="modal-body">
						<input type="hidden" name="action" value="editar_insignia">
						<input type="hidden" name="insignia_id" id="edit-insignia-id">
						<div class="mb-3">
							<label for="edit-insignia-nome" class="form-label">Nome da Conquista</label>
							<input type="text" class="form-control" id="edit-insignia-nome" name="nome" required>
						</div>
						<div class="mb-3">
							<label for="edit-insignia-code" class="form-label">Código de Referência</label>
							<input type="text" class="form-control" id="edit-insignia-code" name="achievement_code" required>
						</div>
						<div class="mb-3">
							<label for="edit-insignia-descricao" class="form-label">Como conseguir</label>
							<textarea class="form-control" id="edit-insignia-descricao" name="descricao"></textarea>
						</div>
						<div class="mb-3">
							<label for="edit-insignia-score" class="form-label">Pontuação Mínima</label>
							<input type="number" class="form-control" id="edit-insignia-score" name="requisito_score">
						</div>
                        <div class="mb-3">
                            <label for="edit-insignia-desc" class="form-label">Descrição (Lore)</label>
                            <textarea class="form-control" id="edit-insignia-desc" name="descricao" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
							<label for="edit-insignia-url" class="form-label">Caminho da Imagem</label>
							<input type="text" class="form-control" id="edit-insignia-url" name="caminho_imagem" required>
						</div>
                        
                        <hr>
                        <h6 class="text-info">Bônus de Destaque (Opcional)</h6>
                        <p class="small text-muted">Se esta insígnia for "destacada" pelo jogador, ela concederá este bônus.</p>
                        
                        <div class="row">
                            <div class="col-7">
                                <label for="edit-insignia-bonus-type" class="form-label">Tipo de Bônus</label>
                                <select class="form-select" name="bonus_type" id="edit-insignia-bonus-type">
                                    <option value="NONE">Nenhum Bônus</option>
                                    {% if achievement_bonus_types %}
                                    {% for code, desc in achievement_bonus_types.items() %}
                                        <option value="{{ code }}">{{ desc }}</option>
                                    {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                            <div class="col-5">
                                <label for="edit-insignia-bonus-value" class="form-label">Valor do Bônus</label>
                                <input type="number" step="0.1" class="form-control" name="bonus_value" id="edit-insignia-bonus-value" placeholder="Ex: 5 ou 2.5">
                            </div>

					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
						<button type="submit" class="btn btn-info">Salvar Alterações</button>
					</div>
				</form>
			</div>
		</div>
	</div>

    <div class="modal fade modal-lg" id="editModalPerfil" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Perfil de <span id="perfil-nome"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <form action="{{ url_for('admin_v2_bp.content_hub') }}" method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="editar_perfil"> 
                        <input type="hidden" name="perfil_id" id="edit-perfil-id">

                        <div class="row g-3">
                            <div class="col-md-6">
                                <h5>Dados Principais</h5>
                                <div class="mb-3"><label class="form-label">Pontuação Atual</label><input type="number" class="form-control" id="edit-score-atualizado" name="score_atual" required></div>
                                <div class="mb-3"><label class="form-label text-warning"><i class="bi bi-coin"></i> G-Coins (Moedas)</label><input type="number" class="form-control" id="edit-moedas" name="moedas" min="0"></div>
                                <div class="mb-3"><label class="form-label">Dias de Vigilante (Ofensiva)</label><input type="number" class="form-control" id="edit-streak" name="current_streak" min="0"></div>
                                <div class="mb-3"><label class="form-label">Tokens de Retake</label><input type="number" class="form-control" id="edit-tokens" name="retake_tokens" min="0"></div>
                                <div class="mb-3"><label class="form-label">Quizzes Perfeitos (Cumulativo)</label><input type="number" class="form-control" id="edit-perfect-cumulative" name="perfect_quiz_cumulative_count" min="0"></div>
                            </div>
                            <div class="col-md-6">
                                <h5>Personalização e Acesso</h5>
                                <div class="mb-3"><label class="form-label">Especialização (Caminho)</label>
                                    <select class="form-select" id="edit-specialization" name="specialization_id">
                                        <option value="">Nenhum Caminho</option>
                                        {% for spec in specializations %}<option value="{{ spec.id }}">{{ spec.name }}</option>{% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3"><label class="form-label">Nickname</label><input type="text" class="form-control" id="edit-nickname" name="nickname"></div>
                                <div class="mb-3"><label class="form-label">Insígnia em Destaque</label>
                                    <select class="form-select" id="edit-featured-insignia" name="featured_insignia_id">
                                        <option value="">Nenhuma</option>
                                        {% for insignia in insignias %}<option value="{{ insignia.id }}">{{ insignia.nome }}</option>{% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3"><label class="form-label">Cor do Nome</label><input type="color" class="form-control form-control-color" id="edit-name-color" name="name_color"></div>
                            </div>
                        </div>
                        <hr>
                        <h5>Configurações</h5>
                        <div class="mb-3"><label class="form-label">Departamento</label><input type="text" class="form-control" id="edit-departamento" name="departamento" required></div>
                        <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="edit-is-admin" name="is_admin"><label class="form-check-label">Permissão de Admin</label></div>
                        <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="edit-opt-in-ranking" name="opt_in_ranking"><label class="form-check-label">Optar por exibir nome no ranking</label></div>
                        <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="edit-is-anonymous" name="is_anonymous"><label class="form-check-label">Perfil Anônimo</label></div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-info">Salvar Alterações</button></div>
                </form>
            </div>
        </div>
    </div>


{% endmacro %}




{# ==================================================================== #}
{# BLOCO DE SCRIPTS                             #}
{# ==================================================================== #}
{% macro render_quiz_assets() %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        
        // --- LÓGICA PARA POPULAR O MODAL DE EVENTOS ---
        var editModalEvento = document.getElementById('editModalEvento');
        if (editModalEvento) {
            editModalEvento.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var eventoId = button.getAttribute('data-id');
                var eventoNome = button.getAttribute('data-nome');
                var eventoPontuacao = button.getAttribute('data-pontuacao');
                var eventoDescricao = button.getAttribute('data-descricao');
                editModalEvento.querySelector('#edit-evento-id').value = eventoId;
                editModalEvento.querySelector('#edit-nome').value = eventoNome;
                editModalEvento.querySelector('#edit-pontuacao').value = eventoPontuacao;
                editModalEvento.querySelector('#edit-descricao').value = eventoDescricao;
            });
        }

        // --- LÓGICA PARA POPULAR O MODAL DE NÍVEIS ---
        var editModalNivel = document.getElementById('editModalNivel');
        if (editModalNivel) {
            editModalNivel.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var nivelId = button.getAttribute('data-id');
                var nivelNome = button.getAttribute('data-nome');
                var nivelScore = button.getAttribute('data-score-minimo');
                var nivelUrl = button.getAttribute('data-badge-url');
                editModalNivel.querySelector('#edit-nivel-id').value = nivelId;
                editModalNivel.querySelector('#edit-nivel-nome').value = nivelNome;
                editModalNivel.querySelector('#edit-nivel-score').value = nivelScore;
                editModalNivel.querySelector('#edit-nivel-url').value = nivelUrl;
            });
        }

        // --- LÓGICA PARA POPULAR O MODAL DE INSÍGNIAS (CONQUISTAS) ---
    var editModalInsignia = document.getElementById('editModalInsignia');
    if (editModalInsignia) {
        editModalInsignia.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var dataset = button.dataset; // Usar dataset é mais limpo
            var modal = this; // 'this' é o editModalInsignia

            var insigniaId = dataset.id;
            var insigniaNome = dataset.nome;
            var insigniaDescricao = dataset.descricao;
            var insigniaScore = dataset.requisitoScore;
            var insigniaUrl = dataset.caminhoImagem;
            var insigniaCode = dataset.code; 
            var bonusType = dataset.bonusType;
            var bonusValue = dataset.bonusValue; 

            modal.querySelector('#edit-insignia-id').value = insigniaId;
            modal.querySelector('#edit-insignia-nome').value = insigniaNome;
            modal.querySelector('#edit-insignia-descricao').value = insigniaDescricao;
            modal.querySelector('#edit-insignia-score').value = insigniaScore;
            modal.querySelector('#edit-insignia-url').value = insigniaUrl;
            modal.querySelector('#edit-insignia-code').value = insigniaCode; 
            modal.querySelector('#edit-insignia-bonus-type').value = bonusType || 'NONE'; 
            modal.querySelector('#edit-insignia-bonus-value').value = bonusValue || ''; 
        });
    }

        // --- LÓGICA PARA POPULAR O MODAL DE PERFIS ---
        var editModalPerfil = document.getElementById('editModalPerfil');
        if (editModalPerfil) {
            editModalPerfil.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var perfilId = button.getAttribute('data-perfil-id');
                var perfilNome = button.getAttribute('data-perfil-nome');
                var perfilScore = button.getAttribute('data-perfil-score');
                var perfilMoedas = button.getAttribute('data-perfil-moedas');
                var perfilStreak = button.getAttribute('data-perfil-streak');
                var perfilIsAdmin = button.getAttribute('data-is-admin') === 'true';
                var perfilDepartamento = button.getAttribute('data-departamento');
                var perfilOptIn = button.getAttribute('data-opt-in') === 'true';
                
                
                editModalPerfil.querySelector('#edit-perfil-id').value = perfilId;
                editModalPerfil.querySelector('#perfil-nome').textContent = perfilNome;
                editModalPerfil.querySelector('#edit-score-atualizado').value = perfilScore;
                editModalPerfil.querySelector('#edit-moedas').value = perfilMoedas;
                editModalPerfil.querySelector('#edit-streak').value = perfilStreak;
                editModalPerfil.querySelector('#edit-departamento').value = perfilDepartamento;
                editModalPerfil.querySelector('#edit-is-admin').checked = perfilIsAdmin;
                editModalPerfil.querySelector('#edit-opt-in-ranking').checked = perfilOptIn;
            });
        }
    });
</script>
{% endmacro %}