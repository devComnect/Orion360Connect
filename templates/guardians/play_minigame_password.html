{% extends "base_template.html" %}
{% from "guardians/macros/assistant_macro.html" import render_assistant %} 
{% block title %}Segredo: Acesso Restrito{% endblock %}

{% block styles %}
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/guardians_css/password_vault.css') }}">
    <style>
        body { background-color: #0b0d10; }
    </style>
{% endblock %}

{% block content %}
{{ render_assistant(assistant_data) }}
<div id="vault-interface" 
     data-timer="{{ remaining_time if remaining_time else 0 }}" 
     data-attempt-id="{{ attempt.id }}"
     data-has-timer="{{ 'true' if config.time_limit_seconds else 'false' }}">

    <header class="cyber-hud">
        <div class="hud-section left">
            <span class="hud-label">TEMPO</span>
            <div id="timer-display" class="hud-value danger">--:--</div>
        </div>

        <div class="hud-section center">
            <div class="system-tag">
                <i class="bi bi-shield-lock-fill"></i> COFRE_SEGURO_V4
            </div>
        </div>

        <div class="hud-section right">
            <button type="button" id="abort-btn" class="btn-abort" title="Abortar Invasão">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </header>

    <main class="vault-content">
        
        <div class="terminal-wrapper">
            <div class="terminal-header">
                <div class="traffic-lights">
                    <span class="light red"></span>
                    <span class="light yellow"></span>
                    <span class="light green"></span>
                </div>
                <div class="terminal-title">root@guardian-server:~# override_auth</div>
            </div>
            
            <div class="terminal-body">
                <div class="input-line">
                    <span class="prompt">&gt;</span>
                    <input type="text" id="passwordInput" class="cmd-input" 
                           placeholder="INSIRA A SENHA..." autocomplete="off" autofocus spellcheck="false">
                </div>
                <div id="validation-msg" class="status-line">Aguardando entrada de dados...</div>
            </div>
        </div>

        <div class="rules-frame">
            <div class="frame-header">REQUISITOS DE SEGURANÇA</div>
            
            <div class="rules-list">
                {% for rule in rules %}
                <div class="rule-card" 
                    data-regex="{{ rule.regex if rule.regex else '' }}"
                    data-js-type="{{ rule.js_type if rule.js_type else '' }}"
                    data-js-val="{{ rule.js_val if rule.js_val else '' }}">
                    <div class="rule-indicator">
                        <i class="bi bi-circle rule-icon"></i>
                    </div>
                    <div class="rule-text">
                        <span class="rule-id">REGRA {{ "%02d" % loop.index }}</span>
                        <p class="rule-desc">{{ rule.desc }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="alert alert-warning d-flex align-items-center border-warning bg-opacity-10 mt-3 mb-4" role="alert" style="background-color: rgba(255, 193, 7, 0.05); border-left: 4px solid #ffc107;">
            <i class="bi bi-exclamation-triangle-fill fs-4 me-3 text-warning"></i>
            <div>
                <strong class="text-uppercase font-tech" style="letter-spacing: 1px;">Protocolo de Segurança Ativo</strong>
                <div class="small text-muted">
                    Não saia da página ou feche o navegador. A desconexão resultará em <strong>falha imediata</strong> e pontuação zero.
                </div>
            </div>
        </div>

    </main>

</div>

<form id="hidden-form" action="{{ url_for('guardians_bp.submit_password_game_abandon', attempt_id=attempt.id) }}" method="POST" style="display:none;">
    <input type="hidden" name="reason" id="abandon-reason" value="manual">
</form>

<div class="action-dock">
    <div class="container d-flex justify-content-center">
        <button id="submitBtn" class="cyber-btn btn-hack w-100" style="max-width: 500px;" disabled>
            <i class="bi bi-unlock-fill me-2"></i> EXECUTAR DESBLOQUEIO
        </button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- SETUP ---
    const container = document.getElementById('vault-interface');
    const input = document.getElementById('passwordInput');
    const submitBtn = document.getElementById('submitBtn');
    const timerDisplay = document.getElementById('timer-display');
    const abortBtn = document.getElementById('abort-btn');
    const msgBox = document.getElementById('validation-msg');
    const ATTEMPT_ID = container.dataset.attemptId;
    const HAS_TIMER = container.dataset.hasTimer === 'true';
    let timeRemaining = parseFloat(container.dataset.timer);
    
    let isProcessing = false;

    // --- 1. TIMER ---
    if (HAS_TIMER && timeRemaining > 0) {
        const timerInterval = setInterval(() => {
            if(isProcessing) return;
            timeRemaining--;

            const m = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
            const s = Math.floor(timeRemaining % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${m}:${s}`;

            if (timeRemaining < 10) timerDisplay.style.color = '#dc3545'; 
            else if (timeRemaining < 30) timerDisplay.style.color = '#ffc107'; 
            else timerDisplay.style.color = '#0dcaf0'; 

            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                timerDisplay.textContent = "00:00";
                finishGame('timeout'); 
            }
        }, 1000);
    } else {
        timerDisplay.textContent = "∞"; 
        timerDisplay.style.color = "#198754";
    }

    // --- 2. VALIDAÇÃO EM TEMPO REAL ---
    input.addEventListener('input', () => {
        const pwd = input.value;
        const digits = (pwd.match(/\d/g) || []).map(Number); 
        let allValid = true; 

        document.querySelectorAll('.rule-card').forEach(card => {
            const jsType = card.dataset.jsType; 
            const jsVal = parseInt(card.dataset.jsVal);
            const icon = card.querySelector('.rule-icon');
            let passed = false;

            if (jsType) {
                if (digits.length === 0) {
                    passed = false; 
                } else {
                    if (jsType === 'sum') {
                        const sum = digits.reduce((a, b) => a + b, 0);
                        passed = (sum === jsVal);
                    }
                    else if (jsType === 'sub_first_last' && digits.length >= 2) {
                        passed = (digits[0] - digits[digits.length - 1] === jsVal);
                    }
                    else if (jsType === 'sub_last_first' && digits.length >= 2) {
                        passed = (digits[digits.length - 1] - digits[0] === jsVal);
                    }
                }
            } else {
                const regexStr = card.dataset.regex;
                if (regexStr) {
                    const regex = new RegExp(regexStr);
                    passed = regex.test(pwd);
                }
            }

            if (passed) {
                card.classList.add('valid');
                card.classList.remove('invalid');
                if(icon) icon.className = 'bi bi-check-circle-fill rule-icon text-success';
            } else {
                card.classList.remove('valid');
                if(pwd.length > 0) card.classList.add('invalid');
                else card.classList.remove('invalid');
                
                if(icon) icon.className = 'bi bi-x-circle-fill rule-icon text-danger';
                allValid = false;
            }
        });

        if (pwd.length > 0 && allValid) {
            msgBox.innerHTML = '<i class="bi bi-check-all"></i> PROTOCOLOS SATISFEITOS. PRONTO.';
            msgBox.className = "text-success fw-bold small mt-2";
            submitBtn.disabled = false;
            submitBtn.classList.add('pulse-btn'); 
        } else {
            msgBox.innerHTML = '<i class="bi bi-shield-lock"></i> REQUISITOS PENDENTES...';
            msgBox.className = "text-danger fw-bold small mt-2";
            submitBtn.disabled = true;
            submitBtn.classList.remove('pulse-btn');
        }
    });

    // --- 3. ENVIO (VITÓRIA) ---
    async function submitGame() {
        if(isProcessing) return;
        isProcessing = true;
        
        input.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> PROCESSANDO...';

        try {
            const res = await fetch(`/password-game/submit/${ATTEMPT_ID}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ password: input.value })
            });
            
            const data = await res.json();

            if (data.redirect) {
                if (data.status === 'timeout') alert("Tempo esgotado no servidor!");
                window.location.href = data.redirect;
            } else if (data.status === 'invalid') {
                alert(data.message || "Senha incorreta.");
                isProcessing = false;
                input.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-unlock-fill"></i> EXECUTAR DESBLOQUEIO';
                input.focus();
            } else {
                alert("Erro desconhecido.");
                window.location.reload();
            }

        } catch (e) {
            console.error(e);
            alert("Erro de conexão com o servidor.");
            isProcessing = false;
            input.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-wifi-off"></i> ERRO - TENTAR NOVAMENTE';
        }
    }

    submitBtn.addEventListener('click', submitGame);
    input.addEventListener('keypress', e => {
        if(e.key === 'Enter' && !submitBtn.disabled) submitGame();
    });

    // --- 4. ABANDONO / TIMEOUT (DERROTA) ---
    async function finishGame(reason) {
        if(isProcessing) return;
        isProcessing = true;

        if(reason === 'timeout') {
            timerDisplay.textContent = "TIMEOUT";
            input.disabled = true;
        }

        try {
            const res = await fetch(`/password-game/abandon/${ATTEMPT_ID}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ reason: reason })
            });

            const data = await res.json();

            if (data.redirect) {
                window.location.href = data.redirect;
            } else {
                window.location.href = "{{ url_for('guardians_bp.meu_perfil') }}";
            }

        } catch (e) {
            console.error("Erro ao finalizar:", e);
            window.location.href = "{{ url_for('guardians_bp.meu_perfil') }}";
        }
    }

    abortBtn.addEventListener('click', () => {
        if(confirm("ATENÇÃO: Deseja abortar a missão? Isso contará como falha.")) {
            finishGame('manual');
        }
    });

    input.focus();
});
</script>
{% endblock %}