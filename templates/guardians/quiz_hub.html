{% extends "base_template.html" %}

{% block title %}Hub de Análise de Quizzes{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-warning mb-0">Hub de Análise de Quizzes</h2>
        <a href="{{ url_for('guardians_bp.analytics') }}" class="btn btn-outline-secondary">Voltar para Analytics</a>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-lg-4 col-md-6"><div class="analytics-card"><div class="card-icon"><i class="bi bi-patch-check-fill"></i></div><div class="card-value">{{ total_attempts }}</div><div class="card-label">Total de Tentativas</div></div></div>
        <div class="col-lg-4 col-md-6"><div class="analytics-card"><div class="card-icon"><i class="bi bi-graph-down-arrow"></i></div><div class="card-value">{{ quiz_mais_dificil if quiz_mais_dificil else 'N/A' }}</div><div class="card-label">Quiz Mais Difícil</div></div></div>
        <div class="col-lg-4 col-md-6"><div class="analytics-card"><div class="card-icon"><i class="bi bi-graph-up-arrow"></i></div><div class="card-value">{{ quiz_mais_facil if quiz_mais_facil else 'N/A' }}</div><div class="card-label">Quiz Mais Fácil</div></div></div>
        <div class="col-lg-4 col-md-6"><div class="analytics-card"><div class="card-icon"><i class="bi bi-check2-circle"></i></div><div class="card-value">{{ "%.1f"|format(general_avg_score) }}%</div><div class="card-label">Média Geral de Acertos</div></div></div>
<div class="col-lg-4 col-md-6"><div class="analytics-card"><div class="card-icon"><i class="bi bi-stopwatch"></i></div><div class="card-value">{{ general_avg_time }}s</div><div class="card-label">Tempo Médio de Resposta</div></div></div>
    </div>

    <div class="card bg-dark text-white">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Lista de Quizzes</h5>
            <form method="GET" action="{{ url_for('guardians_bp.quiz_hub') }}" class="d-flex gap-2">
                <input type="search" name="search" class="form-control form-control-sm" placeholder="Buscar por título..." value="{{ search_term or '' }}">
                <select name="sort" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="recent" {% if sort_by == 'recent' %}selected{% endif %}>Mais Recentes</option>
                    <option value="attempts" {% if sort_by == 'attempts' %}selected{% endif %}>Mais Respondidos</option>
                </select>
                <button type="submit" class="btn btn-sm btn-primary">Buscar</button>
            </form>
        </div>
        <div class="card-body">
            <table class="table table-dark table-hover align-middle">
                <thead>
                    <tr>
                        <th>Título do Quiz</th>
                        <th class="text-center">Categoria</th>
                        <th class="text-center">Perguntas</th>
                        <th class="text-center">Data Início</th>
                        <th class="text-center">Data Fim</th>
                        <th class="text-center">Média Acertos</th>
                        <th class="text-center">Tempo Médio</th>
                        <th class="text-center">Tentativas</th>
                        <th class="text-end">Ações</th>
                    </tr>
                </thead>
                    <tbody>
                        {% for info in quizzes_info %}
                            <tr>
                                <td>
                                    <strong>{{ info.quiz.title }}</strong><br>
                                    <small class="text-muted">{{ info.quiz.description or 'Sem descrição.' }}</small>
                                </td>
                                <td class="text-center">
                                    {% if info.quiz.category.value == 'Comum' %}<span class="badge bg-primary">{{ info.quiz.category.value }}</span>
                                    {% elif info.quiz.category.value == 'Especial' %}<span class="badge bg-warning text-dark">{{ info.quiz.category.value }}</span>
                                    {% elif info.quiz.category.value == 'Hardcore' %}<span class="badge bg-danger">{{ info.quiz.category.value }}</span>
                                    {% else %}<span class="badge bg-secondary">{{ info.quiz.category.value }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">{{ info.question_count }}</td>
                                <td class="text-center">{{ info.quiz.activation_date.strftime('%d/%m/%Y') }}</td>
                                <td class="text-center">{{ info.end_date.strftime('%d/%m/%Y') }}</td>

                                <td class="text-center">{{ "%.1f"|format(info.avg_score_percent or 0) }}%</td>
                                <td class="text-center">{{ (info.avg_time or 0)|int }}s</td>

                                <td class="text-center">{{ info.total_attempts }}</td>
                                <td class="text-end">
                                    <a href="{{ url_for('guardians_bp.quiz_analysis', quiz_id=info.quiz.id) }}" class="btn btn-info btn-sm">
                                        <i class="bi bi-bar-chart-line-fill me-1"></i> Analisar
                                    </a>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                {# Atualizado para corresponder ao novo número de colunas #}
                                <td colspan="9" class="text-center text-muted py-4">Nenhum quiz encontrado.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}