<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OKRs</title>
  <link rel="icon" href="{{ url_for('static', filename='img/icone.png') }}">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Estilos customizados -->

  <!-- Plugin de Anota√ß√£o (metas) -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>

  <style>
  body {
    background-color: #121212; /* Cor de fundo escura */
    color: #f0f0f0; /* Cor de texto clara para contraste */
  }

  /* --- Layout √Årvore com CSS Grid --- */
  .fluxograma {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: auto auto auto;
    gap: 3rem 4rem;
    position: relative;
    padding-bottom: 3rem;
    margin-bottom: 3rem;
    color: white;
    padding-top: 60px; /* Ajuste para n√£o sobrepor o topo */
  }

  .fluxo-card {
    min-width: 280px;
    flex-shrink: 0;
    background-color: #26262f;
    border-radius: 10px;
    padding: 1rem;
    color: white;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    position: relative;
    padding: 2rem;
  }

  .fluxo-card h5 {
    font-weight: 700;
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    color: #e0e0ff;
    text-shadow: 0 0 8px rgba(224,224,255,0.7);
  }

  /* Posicionamento dos cards */
  .nivel-1 {
    grid-column: 2;
    grid-row: 1;
  }

  .nivel-2-esq {
    grid-column: 1;
    grid-row: 2;
  }

  .nivel-2-dir {
    grid-column: 3;
    grid-row: 2;
  }

  .nivel-3 {
    grid-column: 2;
    grid-row: 3;
  }

  /* Linhas de conex√£o - usando pseudo elementos */

  /* Linha vertical do topo para o meio (Nivel 1) */
  .nivel-1::after {
    content: "";
    position: absolute;
    bottom: -30px;
    left: 50%;
    width: 4px;
    height: 30px;
    background-color: #666;
    transform: translateX(-50%);
    z-index: 1;
  }

  /* Linhas horizontais que conectam os cards do n√≠vel 1 ao n√≠vel 2 */
  .nivel-2-esq::before,
  .nivel-2-dir::before {
    content: "";
    position: absolute;
    top: -30px;
    width: 50%;
    height: 4px;
    background-color: #666;
    z-index: 1;
  }

  .nivel-2-esq::before {
    right: 0;
    left: auto;
  }

  .nivel-2-dir::before {
    left: 0;
    right: auto;
  }

  /* Linha vertical do n√≠vel 2 para o n√≠vel 3 */
  .nivel-3::before {
    content: "";
    position: absolute;
    top: -30px;
    left: 50%;
    width: 4px;
    height: 30px;
    background-color: #666;
    transform: translateX(-50%);
    z-index: 1;
  }

  /* Linha horizontal que conecta o n√≠vel 2 esq. e dir. */
  .fluxograma::before {
    content: "";
    position: absolute;
    top: 120px; /* Ajuste para que a linha fique no meio entre os cards do n√≠vel 2 */
    left: 30%; /* Alinha com a largura dos cards */
    width: 40%;
    height: 4px;
    background-color: #666;
    z-index: 0;
  }

  /* Ajuste para links (a) n√£o interferirem */
  .info-item a {
    color: #fff;
    text-decoration: underline;
    cursor: pointer;
  }
</style>

</head>

<body>
  {% include 'header/model-header.html' %}

  <div class="container-fluid my-4 px-5">
    <!-- Bot√£o Voltar-->
    <div class="row mb-2">
      <div class="col-auto">
        <div class="btn-group" role="group" aria-label="bottomVoltar">
          <a href="{{ url_for('home_bp.render_insights') }}" class="btn btn-outline-secondary">Voltar</a>
        </div>
      </div>
    </div>

    <div class="row justify-content-center text-white">
      <h1 class="text-center">OKRs</h1>
    </div>


    <div class="text-end mb-3">
      <button class="btn btn-sm btn-outline-light me-2" onclick="exportarPDF()">üìÑ Exportar PDF</button>
      <button class="btn btn-sm btn-outline-light" onclick="exportarExcel()">üìä Exportar Excel</button>
    </div>

    <!-- Bot√µes de filtro de per√≠odo -->
    <div class="row justify-content-center mb-4">
      <div class="col-auto">
        <div class="btn-group">
          <button class="btn btn-outline-secondary filtro-btn" data-dias="30">M√™s</button>
          <button class="btn btn-outline-secondary filtro-btn" data-dias="90">Trimestre</button>
          <button class="btn btn-outline-secondary filtro-btn" data-dias="180">Semestre</button>
        </div>
      </div>
    </div>

    <!-- Fluxograma - layout em √°rvore -->
    <div class="fluxograma text-white">

      <!-- N√≠vel 1 -->
      <div class="fluxo-card nivel-1">
        <h6>Chamados</h6>
        <div class="info-item">
          <span>Reabertos</span>
          <span class="value text-white">
            <a href="#" onclick="mostrarChamadosOperador('Chamados Reabertos do Operador', chamadosReabertosCodigos)">
              <span id="chamado_reaberto">0</span>
            </a> / <span id="percentual_reaberto">0</span>
          </span>
        </div>
        <div class="info-item">
          <span>FCR</span>
          <span class="value text-white">
            <a href="#" onclick="mostrarChamadosOperador('Chamados com FCR do Operador', chamadosFcrCodigos)">
              <span id="chamado_fcr">0</span>
            </a> / <span id="percentual_fcr">0</span>
          </span>
        </div>
      </div>

      <!-- N√≠vel 2 esquerdo -->
      <div class="fluxo-card nivel-2-esq">
        <h6>Tempo M√©dio</h6>
        <h6 class="text-center mb-2">Chamados</h6>
        <div class="info-item"><span class="text-warning">TMA</span><span class="value" id="percentual-tma">0</span></div>
        <div class="info-item"><span class="text-success">TMS</span><span class="value" id="percentual-tms">0</span></div>
        <h6 class="text-center mt-3 mb-2">Liga√ß√µes</h6>
        <div class="info-item"><span class="text-success">TMIN</span><span class="value" id="percentual-tma-ligacoes">0</span></div>
        <div class="info-item"><span class="text-danger">TMAX</span><span class="value" id="percentual-tms-ligacoes">0</span></div>
      </div>

      <!-- N√≠vel 2 direito -->
      <div class="fluxo-card nivel-2-dir">
        <h6>SLA</h6>
        <h6 class="text-center mb-2">Atendimento</h6>
        <div class="info-item">
          <span class="text-danger">Expirados</span>
          <span class="value"><a href="#" onclick="mostrarCodigosSla('Atendimento Expirado', codigosAtendimento)"><span id="sla_atendimento_expirado">0</span></a></span>
        </div>
        <div class="info-item"><span class="text-success">No Prazo</span><span class="value" id="sla_atendimento_prazo">0</span></div>
        <h6 class="text-center mt-3 mb-2">Resolu√ß√£o</h6>
        <div class="info-item">
          <span class="text-danger">Expirados</span>
          <span class="value"><a href="#" onclick="mostrarCodigosSla('Resolu√ß√£o Expirada', codigosResolucao)"><span id="sla_resolucao_expirado">-</span></a></span>
        </div>
        <div class="info-item"><span class="text-success">No Prazo</span><span class="value" id="percentual_prazo_resolucao">0</span></div>
      </div>

      <!-- N√≠vel 3 -->
      <div class="fluxo-card nivel-3">
        <h6>Satisfa√ß√£o</h6>
        <div class="info-item"><span>CSAT</span><span class="value" id="csat-percentual">0%</span></div>
        <div class="info-item"><span>Total Avaliado</span><span class="value" id="total-avaliado">0</span></div>
        <div class="info-item"><span>CES</span><span class="value" id="ces-nota">0</span></div>
        <div class="info-item"><span>Classifica√ß√£o CES</span><span class="value" id="ces-descricao">-</span></div>
        <div class="info-item"><span>NPS</span><span class="value" id="nps-retorno">0</span></div>
        <div class="info-item"><span>Classifica√ß√£o NPS</span><span class="value" id="nps-null">0</span></div>
      </div>
    </div>

    <!-- Gr√°fico de Evolu√ß√£o Mensal dos OKRs -->
  <div class="row mt-5">
    <div class="col-12">
      <div class="fluxo-card" style="position: relative; padding: 2rem;">
        <h5 class="text-center mb-4" style="font-weight: 700; font-size: 1.5rem; color: #e0e0ff; text-shadow: 0 0 8px rgba(224,224,255,0.7);">
          Evolu√ß√£o Mensal dos OKRs
        </h5>
        <canvas id="graficoEvolucaoOKRs" height="200"></canvas>
      </div>
    </div>
</div>

  </div> <!-- FIM da container-fluid -->

  <!-- Chart Data Labels -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- html2pdf para exportar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- SheetJS para exportar Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Script do Gr√°fico -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const ctx = document.getElementById('graficoEvolucaoOKRs').getContext('2d');

      // ‚úÖ REGISTRA O PLUGIN
      Chart.register(window['chartjs-plugin-annotation']);

      const dadosExemplo = {
        labels: ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho'],
        datasets: [
          {
            label: 'SLA Atendimento (%)',
            data: [97, 95, 93, 96, 94, 98],
            borderColor: '#4caf50',
            backgroundColor: 'rgba(76, 175, 80, 0.4)',
            tension: 0.3
          },
          {
            label: 'SLA Solu√ß√£o (%)',
            data: [96, 94, 92, 95, 93, 97],
            borderColor: '#2196f3',
            backgroundColor: 'rgba(33, 150, 243, 0.4)',
            tension: 0.3
          },
          {
            label: 'FCR (%)',
            data: [85, 88, 86, 87, 90, 92],
            borderColor: '#ff9800',
            backgroundColor: 'rgba(255, 152, 0, 0.4)',
            tension: 0.3
          },
          {
            label: 'TMA (min)',
            data: [4, 4.5, 5.2, 4.7, 4.1, 3.9],
            borderColor: '#e91e63',
            backgroundColor: 'rgba(233, 30, 99, 0.4)',
            tension: 0.3
          },
          {
            label: 'CSAT (%)',
            data: [94, 95, 92, 96, 97, 93],
            borderColor: '#9c27b0',
            backgroundColor: 'rgba(156, 39, 176, 0.4)',
            tension: 0.3
          }
        ]
      };

      new Chart(ctx, {
        type: 'line',
        data: dadosExemplo,
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
              labels: { color: '#fff' }
            },
            annotation: {
              annotations: {
                linhaMeta: {
                  type: 'line',
                  yMin: 95,
                  yMax: 95,
                  borderColor: 'red',
                  borderWidth: 2,
                  label: {
                    content: 'Meta: 95%',
                    enabled: true,
                    position: 'end',
                    backgroundColor: 'rgba(255,0,0,0.7)',
                    color: '#fff'
                  }
                }
              }
            },
            datalabels: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#fff' }
            },
            x: {
              ticks: { color: '#fff' }
            }
          }
        }
      });
    });

    // Fun√ß√µes fict√≠cias para links clic√°veis
    function mostrarChamadosOperador(titulo, codigos) {
      alert(`${titulo}\nC√≥digos: ${codigos.join(', ')}`);
    }
    function mostrarCodigosSla(titulo, codigos) {
      alert(`${titulo}\nC√≥digos: ${codigos.join(', ')}`);
    }

    // Exportar PDF (exemplo)
    function exportarPDF() {
      const element = document.body;
      html2pdf().from(element).save('OKRs.pdf');
    }

    // Exportar Excel (exemplo)
    function exportarExcel() {
      alert('Funcionalidade de exportar Excel ainda n√£o implementada.');
    }
  </script>
</body>
</html>
